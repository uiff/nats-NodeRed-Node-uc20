<script type="text/javascript">
  RED.nodes.registerType('uos-config', {
    category: 'config',
    defaults: {
      host: { value: '127.0.0.1', required: true },
      port: { value: 49360, required: true, validate: RED.validators.number() },
      clientName: { value: 'nodered', required: true },
      scope: { value: 'hub.variables.provide hub.variables.readwrite', required: true },
    },
    credentials: {
      clientId: { type: 'text', required: true },
      clientSecret: { type: 'password', required: true },
    },
    label: function () {
      return this.clientName ? `u-OS ${this.clientName}` : 'u-OS NATS';
    },
    oneditprepare: function() {
      const node = this;
      const $scopeDisplay = $('#uos-scope-display');
      const $scopeSpinner = $('#uos-scope-spinner');
      const $refresh = $('#uos-scope-refresh');
      const updateDisplay = (text, cls = '') => {
        $scopeDisplay.text(text);
        $scopeDisplay.removeClass('form-tips-warning form-tips-error');
        if (cls) {
          $scopeDisplay.addClass(cls);
        }
      };
      const fetchScopes = () => {
        const configId = node.id;
        if (!configId || !node.credentials || !node.credentials.clientId) {
          updateDisplay('Save credentials and deploy to fetch granted scopes.');
          return;
        }
        $scopeSpinner.show();
        $.getJSON(`uos/oauth-scopes/${configId}`)
          .done((data) => {
            if (data && data.scope) {
              updateDisplay(data.scope);
            }
            else {
              updateDisplay('The client did not return a scope string.');
            }
          })
          .fail((xhr) => {
            const msg = xhr?.responseJSON?.error || xhr.statusText || 'Could not read scopes';
            updateDisplay(msg);
          })
          .always(() => {
            $scopeSpinner.hide();
          });
      };
      $refresh.on('click', function (evt) {
        evt.preventDefault();
        fetchScopes();
      });
      if (node.credentials && node.credentials.clientId) {
        fetchScopes();
      }
    },
  });
</script>

<script type="text/html" data-template-name="uos-config">
  <div class="form-row">
    <label for="node-config-input-host"><i class="fa fa-globe"></i> Host</label>
    <input type="text" id="node-config-input-host" placeholder="127.0.0.1">
  </div>
  <div class="form-row">
    <label for="node-config-input-port"><i class="fa fa-plug"></i> Port</label>
    <input type="number" id="node-config-input-port">
  </div>
  <div class="form-row">
    <label for="node-config-input-clientName"><i class="fa fa-user"></i> Client Name</label>
    <input type="text" id="node-config-input-clientName" placeholder="nodered">
  </div>
  <div class="form-row">
    <label for="node-config-input-clientId"><i class="fa fa-id-card"></i> Client ID</label>
    <input type="text" id="node-config-input-clientId">
  </div>
  <div class="form-row">
    <label for="node-config-input-clientSecret"><i class="fa fa-key"></i> Client Secret</label>
    <input type="password" id="node-config-input-clientSecret">
  </div>
  <div class="form-row">
    <label for="node-config-input-scope"><i class="fa fa-list"></i> Scope</label>
    <input type="text" id="node-config-input-scope">
  </div>
  <div class="form-row">
    <label><i class="fa fa-info-circle"></i> Granted scopes</label>
    <div style="display:flex; align-items:center; gap:0.5rem;">
      <button class="red-ui-button" id="uos-scope-refresh" type="button">Refresh</button>
      <span id="uos-scope-display" class="form-tips">Save first to query granted scopes.</span>
      <span id="uos-scope-spinner" class="fa fa-spinner fa-spin" style="display:none;"></span>
    </div>
  </div>
</script>

<script type="text/html" data-help-name="uos-config">
  <p><strong>u-OS Config</strong> stores the shared connection settings for all DataHub nodes.</p>
  <ul>
    <li><strong>Host / Port</strong> – IP and NATS port of the controller (default <code>127.0.0.1:49360</code>).</li>
    <li><strong>Client Name</strong> – Friendly identifier used in NATS connection logs.</li>
    <li><strong>Client ID / Secret</strong> – OAuth credentials from your u-OS Control Center client.</li>
    <li><strong>Scope</strong> – Space separated scopes; e.g. <code>hub.variables.provide hub.variables.readwrite</code>.</li>
    <li><strong>Granted scopes</strong> – Click <em>Refresh</em> to show what the token endpoint actually returns for this client.</li>
  </ul>
</script>
