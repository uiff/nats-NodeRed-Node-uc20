<script type="text/javascript">
  const FIXED_SCOPE = 'hub.variables.provide hub.variables.readwrite hub.variables.readonly';
  RED.nodes.registerType('uos-config', {
    category: 'config',
    defaults: {
      host: { value: '127.0.0.1', required: true },
      port: { value: 49360, required: true, validate: RED.validators.number() },
      clientName: { value: '', required: true }, // No default, required
      scope: { value: FIXED_SCOPE, required: true },
    },
    credentials: {
      clientId: { type: 'text', required: true },
      clientSecret: { type: 'password', required: true },
    },
    label: function () {
      return this.clientName ? `u-OS ${this.clientName}` : 'u-OS NATS';
    },
    oneditprepare: function () {
      const node = this;
      console.log('uos-config oneditprepare', node);
      const $scopeDisplay = $('#uos-scope-display');
      const $scopeSpinner = $('#uos-scope-spinner');
      const $refresh = $('#uos-scope-refresh');

      // Ensure red border for empty required fields is handled by Node-RED standard 'required: true'
      // but we removed the default value for clientName so it starts empty.

      const updateDisplay = (text, cls = '') => {
        $scopeDisplay.text(text);
        $scopeDisplay.removeClass('form-tips-warning form-tips-error');
        if (cls) {
          $scopeDisplay.addClass(cls);
        }
      };
      const fetchScopes = () => {
        const configId = node.id;
        if (!configId || !node.credentials || !node.credentials.clientId) {
          updateDisplay('Save credentials and deploy to fetch granted scopes.');
          return;
        }
        $scopeSpinner.show();
        $.getJSON(`uos/oauth-scopes/${configId}`)
          .done((data) => {
            if (data && data.scope) {
              updateDisplay(data.scope);
            }
            else {
              updateDisplay('The client did not return a scope string.');
            }
          })
          .fail((xhr) => {
            const msg = xhr?.responseJSON?.error || xhr.statusText || 'Could not read scopes';
            updateDisplay(msg);
          })
          .always(() => {
            $scopeSpinner.hide();
          });
      };
      $refresh.on('click', function (evt) {
        evt.preventDefault();
        fetchScopes();
      });
      $('#node-config-input-scope').val(FIXED_SCOPE);
      $('#uos-scope-fixed').text(FIXED_SCOPE);

      const $testBtn = $('#uos-config-test-connection');
      const $testStatus = $('#uos-test-status');

      $testBtn.on('click', function () {
        // Collect current values directly from inputs
        const host = $('#node-config-input-host').val();
        const port = $('#node-config-input-port').val();
        const clientId = $('#node-config-input-clientId').val();
        const clientSecret = $('#node-config-input-clientSecret').val();

        // Show the status box
        $testStatus.show();

        if (!host || !clientId || !clientSecret) {
          $testStatus.html('<span style="color:var(--red-ui-text-color-error)"><i class="fa fa-exclamation-triangle"></i> Please fill Host, Client ID and Secret</span>');
          return;
        }

        $testBtn.prop('disabled', true);
        $testStatus.html('<i class="fa fa-spinner fa-spin"></i> Connecting...');

        $.ajax({
          url: 'uos/check-connection',
          type: 'POST',
          data: { host, port, clientId, clientSecret },
          success: function (resp) {
            $testStatus.html(`<span style="color:green"><i class="fa fa-check"></i> Connection OK! Found <strong>${resp.providers}</strong> providers.</span>`);
            // Cache the providers list globally so input nodes can use it before deploy
            if (resp.providersList) {
              window.uOSProvidersCache = window.uOSProvidersCache || {};
              window.uOSProvidersCache[node.id] = resp.providersList;
            }
            // Cache credentials explicitly for stateless variable browsing
            window.uOSTempConfig = window.uOSTempConfig || {};
            window.uOSTempConfig[node.id] = {
              host,
              clientId,
              clientSecret
            };
          },
          error: function (jqXHR, textStatus, errorThrown) {
            const msg = jqXHR.responseJSON?.error || textStatus;
            $testStatus.html(`<span style="color:var(--red-ui-text-color-error)"><i class="fa fa-times"></i> Error: ${msg}</span>`);
          },
          complete: function () {
            $testBtn.prop('disabled', false);
          }
        });
      });

      if (node.credentials && node.credentials.clientId) {
        fetchScopes();
      }
    },
  });
</script>

<script type="text/html" data-template-name="uos-config">
  <div class="form-row">
    <label for="node-config-input-host"><i class="fa fa-globe"></i> Host</label>
    <input type="text" id="node-config-input-host" placeholder="127.0.0.1">
  </div>
  <div class="form-row">
    <label for="node-config-input-port"><i class="fa fa-plug"></i> Port</label>
    <input type="number" id="node-config-input-port">
  </div>
  <div class="form-row">
    <label for="node-config-input-clientName"><i class="fa fa-user"></i> Client Name</label>
    <input type="text" id="node-config-input-clientName" placeholder="nodered">
  </div>
  <div class="form-row">
    <label for="node-config-input-clientId"><i class="fa fa-id-card"></i> Client ID</label>
    <input type="text" id="node-config-input-clientId">
  </div>
  <div class="form-row">
    <label for="node-config-input-clientSecret"><i class="fa fa-key"></i> Client Secret</label>
    <input type="password" id="node-config-input-clientSecret">
  </div>
  <input type="hidden" id="node-config-input-scope">
  <div class="form-row">
    <label><i class="fa fa-list"></i> Scope</label>
    <span id="uos-scope-fixed" class="form-tips"></span>
  </div>
  <div class="form-row">
     <button class="red-ui-button" id="uos-config-test-connection" type="button" style="width:100%">
       <i class="fa fa-plug"></i> Test Connection & List Providers
     </button>
     <!-- Initially hidden, only shown after click. Same width behavior inherited from container logic. -->
     <div id="uos-test-status" class="form-tips" style="margin-top:5px; display:none;"></div>
  </div>
</script>

<script type="text/html" data-help-name="uos-config">
  <p><strong>u-OS Config</strong> stores the connection settings used by all DataHub nodes (IN and OUT).</p>
  
  <h3>Setup Steps</h3>
  
  <h4>1. Create OAuth Client in u-Control</h4>
  <p>Before configuring Node-RED, create an OAuth client on your u-Control device:</p>
  <ol>
    <li>Open the <b>u-OS Web Interface</b> (e.g. <code>http://192.168.10.100</code>)</li>
    <li>Go to <b>u-OS Control Center</b> → <b>Identity & access</b> → <b>Clients</b></li>
    <li>Click <b>"Add client"</b></li>
    <li>Enter a <b>Name</b> (e.g. <code>nodered</code>)</li>
    <li>Select <b>all</b> <code>hub.variables.*</code> scopes:
      <ul>
        <li><code>hub.variables.provide</code> – Allows creating providers (for OUT node)</li>
        <li><code>hub.variables.readonly</code> – Allows reading variables (for IN node)</li>
        <li><code>hub.variables.readwrite</code> – Allows writing variables (for advanced use)</li>
      </ul>
    </li>
    <li><b>Save</b> and copy the <b>Client ID</b> and <b>Client Secret</b></li>
  </ol>

  <h4>2. Configure this Node</h4>
  <dl>
    <dt>Host</dt>
    <dd>
      IP address of your u-Control device.
      <br><b>Example:</b> <code>192.168.10.100</code>
    </dd>

    <dt>Port</dt>
    <dd>
      NATS port (usually <code>49360</code>).
      <br><b>Default:</b> <code>49360</code>
    </dd>

    <dt>Client Name</dt>
    <dd>
      Name of this connection (e.g. <code>nodered</code>).<br>
      This is <b>mandatory</b> and helps identify logs.
    </dd>

    <dt>Client ID</dt>
    <dd>
      The OAuth Client ID from step 1.
      <br><b>Example:</b> <code>my-oauth-client-id</code>
    </dd>

    <dt>Client Secret</dt>
    <dd>
      The OAuth Client Secret from step 1. Stored encrypted.
    </dd>

    <dt>Scope (Fixed)</dt>
    <dd>
      Automatically set to: <code>hub.variables.provide hub.variables.readwrite hub.variables.readonly</code>
      <br>This ensures all DataHub features work correctly.
    </dd>
  </dl>

  <h4>3. Test Connection</h4>
  <p>
    Click <b>"Test Connection & List Providers"</b> to verify:
  </p>
  <ul>
    <li>✅ Credentials are correct</li>
    <li>✅ Network connection works</li>
    <li>✅ Provider list can be fetched</li>
  </ul>
  <p>
    On success, you'll see: <i>"Connection OK! Found X providers."</i>
  </p>

  <h3>Troubleshooting</h3>
  
  <h4>Test Connection fails</h4>
  <ul>
    <li>Check Host/Port are correct and device is reachable</li>
    <li>Verify Client ID/Secret match exactly (no extra spaces)</li>
    <li>Ensure the OAuth client exists in u-Control</li>
    <li>Verify all <code>hub.variables.*</code> scopes are selected in u-Control</li>
  </ul>

  <div style="margin-top:15px; padding-top:10px; border-top:1px solid #ddd; font-size:0.85em; color:#666;">
    <p><b>Developed by <a href="https://www.linkedin.com/in/iotueli/" target="_blank">IoTUeli</a></b></p>
    <p>Not an official Weidmüller product. Community contribution.</p>
  </div>
</script>