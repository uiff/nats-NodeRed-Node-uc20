<script type="text/javascript">
    RED.nodes.registerType('datahub-write', {
        category: 'Weidmueller DataHub',
        color: '#ff9900',
        defaults: {
            name: { value: "" },
            connection: { type: "uos-config", required: true },
            providerId: { value: "", required: true },
            variableId: { value: "", required: false },
            variableKey: { value: "", required: false }
        },
        inputs: 1,
        outputs: 1,
        icon: "datahub-write.svg",
        label: function () {
            return this.name || "DataHub - Write";
        },
        paletteLabel: "DataHub - Write",
        oneditprepare: function () {
            const node = this;
            const $fetchBtn = $('#btn-fetch-vars');
            const $listContainer = $('#variable-list-container');
            const $statusMsg = $('#fetch-status');
            const $searchInput = $('#node-input-var-search');
            const $selectionDisplay = $('#selected-variable-display'); // Will be removed in HTML, but reference might exist in legacy code if not careful. Removed from logic below.

            // Raw Inputs (Hidden)
            const $inputId = $('#node-input-variableId');
            const $inputKey = $('#node-input-variableKey');

            // Styles matching Read Node exactly
            const rowStyle = "display:grid; grid-template-columns: 30px 60px 1fr; align-items:center; padding:4px 0; border-bottom:1px solid #eee; font-family:'Helvetica Neue', Arial, sans-serif; font-size:12px; cursor:pointer;";
            const idStyle = "background:#eee; color:#555; padding:1px 4px; border-radius:3px; font-family:monospace; text-align:center; font-size:11px;";
            const keyStyle = "overflow:hidden; text-overflow:ellipsis; white-space:nowrap; padding-left:10px;";

            // Removed iconStyle, using checkbox instead

            let currentVariables = [];

            // Render List Function
            const renderList = (vars) => {
                $listContainer.empty();
                if (!vars || vars.length === 0) {
                    $listContainer.html('<div style="padding:15px; color:#777; text-align:center;">No variables found.</div>');
                    return;
                }

                vars.forEach(v => {
                    const safeId = (v.id !== undefined) ? v.id : (v.Id !== undefined ? v.Id : 'ERR');
                    const isSelected = String(safeId) === String($inputId.val());

                    const row = $('<div>', { class: 'var-row', style: rowStyle });

                    // Checkbox Container
                    const cbContainer = $('<div>', { style: 'text-align:center;' });
                    // Use actual checkbox to match Read Node visual
                    const cb = $('<input type="checkbox" class="var-checkbox">')
                        .prop('checked', isSelected)
                        .css('cursor', 'pointer');

                    cbContainer.append(cb);

                    // ID
                    const idCol = $('<div>', { style: 'text-align:center;' }).append($('<span>', { style: idStyle }).text(safeId));
                    // Key
                    const keyCol = $('<div>', { style: keyStyle, title: v.key }).text(v.key);

                    row.append(cbContainer).append(idCol).append(keyCol);

                    // Click Handler (Row or Checkbox)
                    const selectRow = () => {
                        // Uncheck all others (Single Force)
                        $('.var-checkbox').prop('checked', false);
                        cb.prop('checked', true);

                        $inputId.val(safeId !== 'ERR' ? safeId : '');
                        $inputKey.val(v.key);
                        $inputId.trigger('change');
                    };

                    // Toggle behavior if clicking already selected? 
                    // Usually for single select, clicking selected does nothing or keeps it selected.
                    // If user clicks checkbox directly:
                    cb.on('click', function (e) {
                        e.stopPropagation(); // prevent row click double bubble
                        if ($(this).prop('checked')) {
                            selectRow();
                        } else {
                            // Allowing deserialize? imply batch mode if none selected
                            $inputId.val('');
                            $inputKey.val('');
                            $inputId.trigger('change');
                        }
                    });

                    row.on('click', function () {
                        // If not checked, check it.
                        if (!cb.prop('checked')) {
                            selectRow();
                        } else {
                            // If already checked, uncheck?
                            cb.prop('checked', false);
                            $inputId.val('');
                            $inputKey.val('');
                            $inputId.trigger('change');
                        }
                    });

                    // Hover effect (Gray, not Blue, matching Read Node)
                    row.on('mouseenter', function () { $(this).css('background', '#f7f7f7'); });
                    row.on('mouseleave', function () { $(this).css('background', 'transparent'); });

                    $listContainer.append(row);
                });

                // Scroll to selection
                const selectedCb = $listContainer.find('.var-checkbox:checked');
                if (selectedCb.length) {
                    $listContainer.scrollTop(selectedCb.closest('.var-row').offset().top - $listContainer.offset().top + $listContainer.scrollTop() - 40);
                }
            };

            // Filter Logic
            $searchInput.on('keyup', function () {
                const term = $(this).val().toLowerCase();
                $listContainer.find('.var-row').each(function () {
                    const text = $(this).find('div:nth-child(3)').text().toLowerCase(); // Key is 3rd column
                    $(this).toggle(text.indexOf(term) > -1);
                });
            });

            // Fetch Handler
            $fetchBtn.on('click', function () {
                const configNodeId = $('#node-input-connection').val();
                const providerId = $('#node-input-providerId').val();

                if (!configNodeId || configNodeId === '_ADD_') {
                    $statusMsg.text('Select Config Node!').css('color', 'red');
                    return;
                }
                if (!providerId) {
                    $statusMsg.text('Enter Provider ID!').css('color', 'red');
                    return;
                }

                $fetchBtn.prop('disabled', true);
                $statusMsg.text('Fetching...').css('color', 'blue');
                $listContainer.html('<div style="padding:20px; text-align:center;"><i class="fa fa-spinner fa-spin"></i> Loading...</div>');

                $.getJSON('uos/providers/' + configNodeId + '/' + providerId + '/variables', function (data) {
                    $fetchBtn.prop('disabled', false);
                    $statusMsg.text('');

                    // Filter: Only writable variables
                    const writableVars = data.filter(v => {
                        const acc = (v.access || v.accessType || '').toUpperCase();
                        return acc.includes('WRITE') || acc === '';
                    });

                    // Sort: ID ascending
                    currentVariables = writableVars.sort((a, b) => {
                        const idA = (a.id !== undefined) ? parseInt(a.id) : (a.Id !== undefined ? parseInt(a.Id) : Infinity);
                        const idB = (b.id !== undefined) ? parseInt(b.id) : (b.Id !== undefined ? parseInt(b.Id) : Infinity);
                        return idA - idB;
                    });

                    renderList(currentVariables);
                    $statusMsg.text(`Loaded ${currentVariables.length} writable variables.`).css('color', 'green');
                }).fail(function (jqxhr) {
                    $fetchBtn.prop('disabled', false);
                    $statusMsg.text('Error: ' + (jqxhr.responseJSON?.error || 'Unknown')).css('color', 'red');
                    $listContainer.html('<div style="padding:15px; color:#c00; text-align:center;">Failed to load variables.</div>');
                });
            });

            // Initial state
            $listContainer.html('<div style="padding:20px; text-align:center; color:#999;">Click <b>Load Variables</b> to browse.</div>');

            // Set initial display (Removed updateSelectionDisplay call)
            // But we might want to manually populate inputs if they are empty? No, defaults handle that.

            const validateVar = () => {
                const hasId = $inputId.val();
                const hasKey = $inputKey.val();
                if (!hasId && !hasKey) {
                    $('#var-validation-error').hide();
                    $('#batch-mode-hint').show();
                } else {
                    $('#var-validation-error').hide();
                    $('#batch-mode-hint').hide();
                }
            };
            $inputId.on('change keyup', validateVar);

            // Initial check
            validateVar();
        },
        oneditsave: function () {
            // Nothing special to save
        }
    });
</script>

<script type="text/html" data-template-name="datahub-write">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Optional">
    </div>

    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-globe"></i> Config</label>
        <input type="text" id="node-input-connection">
    </div>

    <div class="form-row">
        <label for="node-input-providerId"><i class="fa fa-server"></i> Provider ID</label>
        <div style="display:flex; gap:5px;">
            <input type="text" id="node-input-providerId" placeholder="e.g. u_os_adm" style="flex:1;">
            <button id="btn-fetch-vars" class="red-ui-button"><i class="fa fa-refresh"></i> Load Variables</button>
        </div>
        <div id="fetch-status" style="margin-top:5px; font-size:0.9em; min-height:1.2em;"></div>
    </div>

    <!-- Variable List Section -->
    <div class="form-row" style="border:1px solid #ccc; padding:0; border-radius:4px; background:#fff;">
        <div style="background:#f7f7f7; padding:8px 10px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold; font-size:12px;"><i class="fa fa-list-ul"></i> Select Variable</span>
            <input type="text" id="node-input-var-search" placeholder="Filter..." style="width:120px; font-size:11px; padding:2px;">
        </div>
        
        <div style="display:grid; grid-template-columns: 30px 60px 1fr; background:#eee; font-size:11px; font-weight:bold; padding:4px 0; border-bottom:1px solid #ccc;">
            <div style="text-align:center;"><i class="fa fa-check-square-o"></i></div>
            <div style="text-align:center;">ID</div>
            <div style="padding-left:10px;">Name</div>
        </div>

        <div id="variable-list-container" style="height:200px; overflow-y:auto; background:white;">
           <!-- Variables -->
        </div>
    </div>
    
    <!-- Hidden Inputs (Required by Node-RED to save state) -->
    <input type="hidden" id="node-input-variableId">
    <input type="hidden" id="node-input-variableKey">

    <div id="var-validation-error" class="form-tips" style="display:none; color:#c00; margin-top:10px;">
        <i class="fa fa-warning"></i> <b>Please select a variable (or rely on Batch Mode via JSON).</b>
    </div>
    
    <div id="batch-mode-hint" class="form-tips" style="display:none; color:#666; margin-top:10px;">
        <i class="fa fa-info-circle"></i> <b>No variable selected.</b> Node enters <b>Batch Mode</b>.<br>
        Send a JSON object (<code>{"key": value}</code>) to write variables dynamically.
    </div>

    <div class="form-tips" style="margin-top:10px;">
        <i class="fa fa-info-circle"></i> Send <code>msg.payload</code> with the value to write.
    </div>
</script>

<script type="text/html" data-help-name="datahub-write">
    <p><b>DataHub - Write</b> sends write commands to external Data Hub providers to change variable values.</p>
    
    <h3>Purpose</h3>
    <p>Control variables in <b>other providers</b> (not your own). Use this to:</p>
    <ul>
        <li>Toggle flags (e.g., <code>enable_mode = true</code>)</li>
        <li>Update setpoints (e.g., <code>target_temp = 25.5</code>)</li>
        <li>Control external devices via Data Hub</li>
    </ul>

    <h3>Configuration</h3>
    
    <h4>Provider ID</h4>
    <p>The target provider to write to (e.g., <code>u_os_adm</code>, <code>u_os_sbm</code>).</p>
    <p><b>Find it:</b> u-OS Web UI → Data Hub → Providers</p>

    <h4>Select Variable (Single Mode)</h4>
    <p>Click <b>Load Variables</b> to browse. Select a variable to target it specifically.</p>
    <p>If selected, <code>msg.payload</code> is written as the value.</p>
    
    <h4>Batch Mode (Dynamic)</h4>
    <p>If <b>NO variable is selected</b>, you can write multiple variables by sending a JSON object:</p>
    <pre><code>msg.payload = {
  "machine.status": true,
  "machine.speed": 100
};</code></pre>
    <p>The node resolves keys to IDs automatically.</p>

    <h3>Input Format</h3>
    <p>Send the new value as <code>msg.payload</code>:</p>

    <h4>Example: Single Write</h4>
    <pre><code>msg.payload = false;</code></pre>

    <h4>Example: Batch Write (JSON)</h4>
    <pre><code>msg.payload = {
  "channel_0.do": true,
  "channel_1.do": false
};</code></pre>

    <h3>Output</h3>
    <p>Outputs a confirmation message when the write command is sent:</p>
    <pre><code>{
  "success": true,
  "providerId": "u_os_adm",
  "variableId": 5,
  "value": false
}</code></pre>

    <h3>Example Flow</h3>
    <pre><code>[Inject: false] → [DataHub - Write] → [Debug]
                   (Provider: u_os_adm, Variable ID: 5)</code></pre>

    <h3>Important Notes</h3>
    <ul>
        <li>⚠️ <b>Requires write permissions:</b> Your OAuth client must have <code>hub.variables.readwrite</code> scope</li>
        <li>⚠️ <b>Provider must accept writes:</b> Some providers are read-only</li>
        <li>⚠️ <b>Variable must exist:</b> The variable ID must be valid in the target provider</li>
    </ul>

    <h3>Troubleshooting</h3>
    
    <h4>No Response / Error</h4>
    <ul>
        <li>Check Provider ID is correct (u-OS Web UI → Data Hub → Providers)</li>
        <li>Verify Variable ID exists (Providers → Variables tab)</li>
        <li>Ensure OAuth client has <code>hub.variables.readwrite</code> scope</li>
    </ul>

    <h4>Permission Denied</h4>
    <ul>
        <li>Check OAuth client scopes in u-OS (u-OS Control Center → Identity & access → Clients)</li>
        <li>Verify provider allows writes (some system providers are read-only)</li>
    </ul>

    <div style="margin-top:15px; padding-top:10px; border-top:1px solid #ddd; font-size:0.85em; color:#666;">
        <p><b>Developed by <a href="https://iotueli.ch" target="_blank">IoTUeli</a></b></p>
        <p>Not an official Weidmüller product. Community contribution.</p>
    </div>
</script>