<script type="text/javascript">
    RED.nodes.registerType('datahub-write', {
        category: 'Weidmueller DataHub',
        color: '#ff9900',
        defaults: {
            name: { value: "" },
            connection: { type: "uos-config", required: true },
            providerId: { value: "", required: true },
            variableId: { value: "", required: false },
            variableKey: { value: "", required: false }
        },
        inputs: 1,
        outputs: 1,
        icon: "datahub-write.svg",
        align: "right",
        label: function () {
            return this.name || this.providerId || "DataHub - Write";
        },
        paletteLabel: "DataHub - Write",
        oneditprepare: function () {
            const node = this;
            const $fetchBtn = $('#btn-fetch-vars');
            const $listContainer = $('#variable-list-container');
            const $statusMsg = $('#fetch-status');
            const $searchInput = $('#node-input-var-search');

            // Raw Inputs (Hidden)
            const $inputId = $('#node-input-variableId');
            const $inputKey = $('#node-input-variableKey');

            // --- Provider Lookup Logic ---
            $('#btn-lookup-provider').on('click', function () {
                const configNodeId = $('#node-input-connection').val();
                const $btn = $(this);

                if (!configNodeId || configNodeId === "_ADD_") {
                    RED.notify("Please select a valid Configuration Node first.", "error");
                    return;
                }

                $btn.addClass('disabled').html('<i class="fa fa-spinner fa-spin"></i>');

                $.getJSON('uos/providers/' + configNodeId, function (data) {
                    $btn.removeClass('disabled').html('<i class="fa fa-search"></i>');
                    if (!data || data.length === 0) {
                        RED.notify("No providers found.", "warning");
                        return;
                    }
                    const providerList = data.map(p => {
                        const pid = p.id || p.Id || p;
                        return `<li class="red-ui-list-item provider-item" data-id="${pid}" style="cursor: pointer; padding: 8px; border-bottom: 1px solid #eee;">
                            <i class="fa fa-cube"></i> <b>${pid}</b>
                        </li>`;
                    }).join('');
                    const content = `<div style="padding:10px; font-size:12px; color:#666;">Select a target provider:</div>
                                     <ul style="list-style: none; padding: 0; margin:0; max-height: 300px; overflow-y: auto; border:1px solid #ddd;">${providerList}</ul>`;

                    const $dialog = $('<div id="provider-lookup-dialog"></div>').html(content).dialog({
                        title: "Select Target Provider", width: 400, modal: true,
                        buttons: { "Cancel": function () { $(this).dialog("close"); } }
                    });
                    $dialog.find('.provider-item').hover(
                        function () { $(this).css("background-color", "#eef"); },
                        function () { $(this).css("background-color", "white"); }
                    ).click(function () {
                        $("#node-input-providerId").val($(this).data('id'));
                        $dialog.dialog("close").remove();
                    });
                }).fail(function () {
                    $btn.removeClass('disabled').html('<i class="fa fa-search"></i>');
                    RED.notify("Could not fetch providers.", "error");
                });
            });

            // --- Variable List Logic ---
            const rowStyle = "display:grid; grid-template-columns: 30px 1fr; align-items:center; padding:4px 0; border-bottom:1px solid #eee; font-family:'Helvetica Neue', Arial, sans-serif; font-size:12px; cursor:pointer;";
            const keyStyle = "overflow:hidden; text-overflow:ellipsis; white-space:nowrap; padding-left:10px;";

            let currentVariables = [];

            const renderList = (vars) => {
                $listContainer.empty();
                if (!vars || vars.length === 0) {
                    $listContainer.html('<div style="padding:15px; color:#777; text-align:center;">No writable variables found.</div>');
                    return;
                }

                vars.forEach(v => {
                    const safeId = (v.id !== undefined) ? v.id : (v.Id !== undefined ? v.Id : 'ERR');
                    const isSelected = String(v.key) === String($inputKey.val()); // Match by Key primarily now

                    const row = $('<div>', { class: 'var-row', style: rowStyle });
                    const cbContainer = $('<div>', { style: 'text-align:center;' });
                    const cb = $('<input type="checkbox" class="var-checkbox">').prop('checked', isSelected).css('cursor', 'pointer');
                    cbContainer.append(cb);
                    const keyCol = $('<div>', { style: keyStyle, title: v.key }).text(v.key);
                    row.append(cbContainer).append(keyCol);

                    const selectRow = () => {
                        $('.var-checkbox').prop('checked', false);
                        cb.prop('checked', true);
                        $inputId.val(safeId !== 'ERR' ? safeId : '');
                        $inputKey.val(v.key);
                        $inputId.trigger('change');
                    };

                    cb.on('click', function (e) { e.stopPropagation(); if ($(this).prop('checked')) selectRow(); else { $inputId.val(''); $inputKey.val(''); $inputId.trigger('change'); } });
                    row.on('click', function () { if (!cb.prop('checked')) selectRow(); else { cb.prop('checked', false); $inputId.val(''); $inputKey.val(''); $inputId.trigger('change'); } });
                    row.on('mouseenter', function () { $(this).css('background', '#f7f7f7'); });
                    row.on('mouseleave', function () { $(this).css('background', 'transparent'); });

                    $listContainer.append(row);
                });

                // Scroll to selection
                const selectedCb = $listContainer.find('.var-checkbox:checked');
                if (selectedCb.length) $listContainer.scrollTop(selectedCb.closest('.var-row').offset().top - $listContainer.offset().top + $listContainer.scrollTop() - 40);
            };

            $searchInput.on('keyup', function () {
                const term = $(this).val().toLowerCase();
                $listContainer.find('.var-row').each(function () {
                    const text = $(this).find('div:nth-child(2)').text().toLowerCase();
                    $(this).toggle(text.indexOf(term) > -1);
                });
            });

            $fetchBtn.on('click', function () {
                const configNodeId = $('#node-input-connection').val();
                const providerId = $('#node-input-providerId').val();

                if (!configNodeId || configNodeId === '_ADD_') { $statusMsg.text('Select Config Node!').css('color', 'red'); return; }
                if (!providerId) { $statusMsg.text('Enter Provider ID!').css('color', 'red'); return; }

                $fetchBtn.prop('disabled', true);
                $statusMsg.text('Fetching...').css('color', 'blue');
                $listContainer.html('<div style="padding:20px; text-align:center;"><i class="fa fa-spinner fa-spin"></i> Loading...</div>');

                $.getJSON('uos/providers/' + configNodeId + '/' + providerId + '/variables', function (data) {
                    $fetchBtn.prop('disabled', false);
                    $statusMsg.text('');

                    // --- FILTER WRITABLE VARIABLES ---
                    const writableVars = data.filter(v => {
                        // Access can be: READ_ONLY, READ_WRITE, WRITE_ONLY, NONE/undefined
                        // We want READ_WRITE or WRITE_ONLY.
                        // Sometimes access is undefined. If undefined, we assume maybe writable?
                        // Or safer to show all if access is missing.

                        const acc = (v.access || v.accessType || v.Access || '').toUpperCase();

                        if (!acc) return true; // Show if unknown
                        return acc.includes('WRITE');
                    });

                    currentVariables = writableVars.sort((a, b) => {
                        const idA = a.id || a.Id || 0; const idB = b.id || b.Id || 0; return idA - idB;
                    });

                    renderList(currentVariables);
                    $statusMsg.text(`Loaded ${currentVariables.length} writable variables.`).css('color', 'green');
                }).fail(function (jqxhr) {
                    $fetchBtn.prop('disabled', false);
                    $statusMsg.text('Error: ' + (jqxhr.responseJSON?.error || 'Unknown')).css('color', 'red');
                    $listContainer.html('<div style="padding:15px; color:#c00; text-align:center;">Failed to load variables.</div>');
                });
            });

            // Initial state
            const initKey = $inputKey.val();
            if (initKey) {
                renderList([{ id: $inputId.val(), key: initKey }]);
                $statusMsg.text('Selected variable shown. Load again to refresh.').css('color', '#888');
            } else {
                $listContainer.html('<div style="padding:20px; text-align:center; color:#999;">Click <b>Load Variables</b> to browse writable vars.</div>');
            }

            const validateVar = () => {
                const hasKey = $inputKey.val();
                if (!hasKey) { $('#var-validation-error').hide(); $('#batch-mode-hint').show(); }
                else { $('#var-validation-error').hide(); $('#batch-mode-hint').hide(); }
            };
            $inputId.on('change keyup', validateVar);
            validateVar();
        }
    });
</script>

<script type="text/html" data-template-name="datahub-write">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Optional">
    </div>

    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-globe"></i> Config</label>
        <input type="text" id="node-input-connection">
    </div>

    <div class="form-row">
        <label for="node-input-providerId"><i class="fa fa-server"></i> Provider ID</label>
        <div style="display:flex;">
            <input type="text" id="node-input-providerId" placeholder="e.g. u_os_adm" style="flex:1;">
            <a id="btn-lookup-provider" class="red-ui-button" style="margin-left: 5px;" title="Search Providers"><i class="fa fa-search"></i></a>
        </div>
    </div>

    <!-- Variable List Section -->
    <div class="form-row">
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <label><i class="fa fa-list"></i> Variable</label>
             <button id="btn-fetch-vars" class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i> Load Variables</button>
        </div>
        <div id="fetch-status" style="font-size:0.9em; min-height:1.2em; text-align:right; margin-bottom:5px;"></div>
        
        <div style="border:1px solid #ccc; padding:0; border-radius:4px; background:#fff;">
            <div style="background:#f7f7f7; padding:4px 10px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:11px; font-weight:bold;">Select Writable Variable</span>
                <input type="text" id="node-input-var-search" placeholder="Filter..." style="width:100px; font-size:11px; padding:2px;">
            </div>
            
            <div id="variable-list-container" style="height:200px; overflow-y:auto; background:white;">
               <!-- Variables -->
            </div>
            <div style="background:#f7f7f7; padding:4px 10px; border-top:1px solid #ddd; color:#888; font-size:10px; text-align:center;">
                Only variables with Write access are shown.
            </div>
        </div>
    </div>
    
    <input type="hidden" id="node-input-variableId">
    <input type="hidden" id="node-input-variableKey">

    <div id="batch-mode-hint" class="form-tips" style="display:none; color:#666; margin-top:10px;">
        <i class="fa fa-info-circle"></i> <b>No variable selected.</b> Node enters <b>Batch Mode</b>.<br>
        Send a JSON object (<code>{"key": value}</code>) to write variables dynamically.
    </div>

    <div class="form-tips" style="margin-top:10px;">
        <i class="fa fa-info-circle"></i> Send <code>msg.payload</code> with the value to write.
    </div>
</script>

<script type="text/html" data-help-name="datahub-write">
    <p><b>DataHub - Write</b> sends write commands to external Data Hub providers.</p>
    <h3>Configuration</h3>
    <ol>
        <li><b>Provider ID:</b> Target provider (e.g. <code>u_os_adm</code>). Use the search button to find it.</li>
        <li><b>Variable:</b> Select a target variable. <b>Only writable variables are shown.</b></li>
    </ol>
    <p>If no variable is selected, the node works in <b>Batch Mode</b> or <b>Dynamic Mode</b>.</p>
    <ul>
        <li><b>Batch:</b> Send a FLAT JSON object to update multiple keys for the configured Provider: <code>{"key": value, "machine.status": value}</code>. <br><b>Note:</b> Nested objects are NOT flattened automatically. Use dot-notation for keys!</li>
        <li><b>Dynamic:</b> Send a specific object to target ANY Provider/Key:
            <code>
            {
                "provider": "u_os_sbm",
                "key": "ur20_8do_p_1.process_data.channel_7.do",
                "value": true
            }
            </code>
        </li>
        <li><b>Mixed Array:</b> Send an array of dynamic objects to write to multiple providers at once:
            <code>
            [
              { "provider": "u_os_sbm", "key": "doo1", "value": true },
              { "provider": "other_provider", "key": "var2", "value": 123 }
            ]
            </code>
        </li>
    </ul>