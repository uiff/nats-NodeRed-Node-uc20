<script type="text/javascript">
  RED.nodes.registerType('datahub-input', {
    category: 'Weidmueller DataHub',
    color: '#ff9900',
    defaults: {
      name: { value: "" },
      connection: { type: "uos-config", required: true },
      providerId: { value: "", required: true }, // Changed default to empty to encourage selection
      manualVariables: { value: "" },
      triggerMode: { value: "event" },
      pollingInterval: { value: 0, validate: RED.validators.number() },
      pollingUnit: { value: "ms" }
    },
    inputs: 1,
    outputs: 1,
    icon: "datahub-read.svg",
    label: function () {
      if (this.name) return this.name;
      return this.providerId || "DataHub - Read";
    },
    paletteLabel: "DataHub - Read",
    oneditprepare: function () {
      const node = this;

      // --- Trigger Mode & Polling Logic ---
      const $triggerMode = $('#node-input-triggerMode');
      const $pollRow = $('#poll-interval-row');
      const $pollIntInput = $('#node-input-pollingInterval');
      const $pollUnitInput = $('#node-input-pollingUnit');

      // Convert stored ms to unit for display
      let currentMs = node.pollingInterval || 0;
      let uiUnit = node.pollingUnit || 'ms';
      let uiVal = currentMs;

      // If unit is set, reverse convert for display
      if (uiUnit === 'min') {
        uiVal = currentMs / 60000;
      } else if (uiUnit === 's') {
        uiVal = currentMs / 1000;
      } else if (!node.pollingUnit && currentMs > 0) {
        // Heuristic fallback (Legacy): Guess unit if none was saved
        if (currentMs >= 60000 && currentMs % 60000 === 0) { uiVal = currentMs / 60000; uiUnit = 'min'; }
        else if (currentMs >= 1000 && currentMs % 1000 === 0) { uiVal = currentMs / 1000; uiUnit = 's'; }
      }
      $pollUnitInput.val(uiUnit);
      $pollIntInput.val(uiVal);

      const updateTriggerVisibility = () => {
        if ($triggerMode.val() === 'poll') {
          $pollRow.show();
        } else {
          $pollRow.hide();
        }
      };

      $triggerMode.on('change', updateTriggerVisibility);
      updateTriggerVisibility();

      // --- Provider Lookup Logic ---
      $('#btn-lookup-provider').on('click', function () {
        const configNodeId = $('#node-input-connection').val();
        const $btn = $(this);

        if (!configNodeId || configNodeId === "_ADD_") {
          RED.notify("Please select a valid Configuration Node first.", "error");
          return;
        }

        $btn.addClass('disabled').html('<i class="fa fa-spinner fa-spin"></i>');

        $.getJSON('uos/providers/' + configNodeId, function (data) {
          $btn.removeClass('disabled').html('<i class="fa fa-search"></i>');

          if (!data || data.length === 0) {
            RED.notify("No providers found.", "warning");
            return;
          }

          // Build List
          const providerList = data.map(p => {
            const pid = p.id || p.Id || p;
            return `<li class="red-ui-list-item provider-item" data-id="${pid}" style="cursor: pointer; padding: 8px; border-bottom: 1px solid #eee;">
                      <i class="fa fa-cube"></i> <b>${pid}</b>
                  </li>`;
          }).join('');

          const content = `<div style="padding:10px; font-size:12px; color:#666;">Select a provider to read from:</div>
                               <ul style="list-style: none; padding: 0; margin:0; max-height: 300px; overflow-y: auto; border:1px solid #ddd;">${providerList}</ul>`;

          const $dialog = $('<div id="provider-lookup-dialog"></div>')
            .html(content)
            .dialog({
              title: "Select Provider",
              width: 400,
              modal: true,
              buttons: {
                "Cancel": function () { $(this).dialog("close"); }
              }
            });

          // Click Handler
          $dialog.find('.provider-item').hover(
            function () { $(this).css("background-color", "#eef"); },
            function () { $(this).css("background-color", "white"); }
          ).click(function () {
            const selectedId = $(this).data('id');
            $("#node-input-providerId").val(selectedId);
            $dialog.dialog("close");
            $dialog.remove(); // Cleanup
          });

        }).fail(function (jqxhr) {
          $btn.removeClass('disabled').html('<i class="fa fa-search"></i>');
          RED.notify("Could not fetch providers. Ensure Config Node is DEPLOYED.", "error");
        });
      });


      // --- Variable Selector Logic ---
      const $fetchBtn = $('#btn-fetch-vars');
      const $listContainer = $('#variable-list-container');
      const $statusMsg = $('#fetch-status');
      const $searchInput = $('#node-input-var-search');
      const $selectAllBtn = $('#btn-select-all');
      const $clearAllBtn = $('#btn-clear-all');
      const $hiddenManual = $('#node-input-manualVariables');

      const rowStyle = "display:grid; grid-template-columns: 30px 1fr; align-items:center; padding:4px 0; border-bottom:1px solid #eee; font-family:'Helvetica Neue', Arial, sans-serif; font-size:12px;";
      const keyStyle = "overflow:hidden; text-overflow:ellipsis; white-space:nowrap; padding-left:10px;";

      let currentVariables = [];

      // Parse existing selection
      const getSelectedMap = () => {
        const selected = new Map();
        const raw = $hiddenManual.val();
        if (raw) {
          raw.split(',').forEach(entry => {
            const parts = entry.split(':');
            if (parts.length === 2) {
              selected.set(parts[0].trim(), parts[1].trim());
            }
          });
        }
        return selected;
      };

      const renderList = (vars) => {
        $listContainer.empty();
        if (!vars || vars.length === 0) {
          $listContainer.append('<div style="padding:15px; color:#777; text-align:center;">No variables found.</div>');
          return;
        }

        const selectedMap = getSelectedMap();

        // Grouping Logic
        const groups = {};
        const noGroup = [];

        vars.forEach(v => {
          const key = v.key || '';
          const parts = key.split('.');
          if (parts.length > 1) {
            const groupName = parts[0];
            if (!groups[groupName]) groups[groupName] = [];
            groups[groupName].push(v);
          } else {
            noGroup.push(v);
          }
        });

        // Helper to render a single row
        const createRow = (v) => {
          let rawId = (v.id !== undefined && v.id !== null) ? v.id : v.Id;
          const safeId = (rawId !== undefined && rawId !== null) ? rawId : 'ERR';
          const isSelected = selectedMap.has(v.key);

          const row = $('<div>', { class: 'var-row', style: rowStyle });
          const cbContainer = $('<div>', { style: 'text-align:center;' });
          const cb = $('<input type="checkbox" class="var-checkbox">')
            .prop('checked', isSelected)
            .data('key', v.key)
            .data('id', safeId);
          cbContainer.append(cb);
          const label = $('<div>', { style: keyStyle, title: v.key }).text(v.key);
          row.append(cbContainer).append(label);
          return row;
        };

        // Render Groups
        Object.keys(groups).sort().forEach(groupName => {
          const groupVars = groups[groupName];

          // Header
          const header = $('<div>', {
            style: 'background:#eee; padding:5px 10px; font-weight:bold; cursor:pointer; border-bottom:1px solid #ddd; display:flex; align-items:center;'
          });
          const icon = $('<i class="fa fa-caret-right" style="margin-right:5px; width:10px;"></i>');
          header.append(icon).append($('<span>').text(groupName + ` (${groupVars.length})`));

          // Container for items
          const itemContainer = $('<div>', { style: 'display:none; padding-left:0;' });

          groupVars.forEach(v => {
            itemContainer.append(createRow(v));
          });

          // Toggle Logic
          header.click(function () {
            const isVisible = itemContainer.is(':visible');
            itemContainer.toggle(!isVisible);
            icon.removeClass(isVisible ? 'fa-caret-down' : 'fa-caret-right').addClass(isVisible ? 'fa-caret-right' : 'fa-caret-down');
          });

          // Auto-expand if any child is selected OR if filtering
          const hasSelection = groupVars.some(v => selectedMap.has(v.key));
          if (hasSelection) {
            header.click(); // Expand
          }

          $listContainer.append(header).append(itemContainer);
        });

        // Render Ungrouped
        if (noGroup.length > 0) {
          const header = $('<div>', {
            style: 'background:#eee; padding:5px 10px; font-weight:bold; border-bottom:1px solid #ddd; color:#666;'
          }).text('Other Variables');
          $listContainer.append(header);

          noGroup.forEach(v => {
            $listContainer.append(createRow(v));
          });
        }
      };

      // Adjusted filter to open groups when searching
      const filterList = (term) => {
        const termLower = term.toLowerCase();

        // Show all containers first to filter their rows
        $listContainer.children().show();

        // Iterate groups (header + div container pairs)
        // Group Headers are usually direct children?
        // Actually, logic needs to be robust.

        // Simplest: Re-render? No, state/checkboxes lost.
        // Hiding logic:
        $listContainer.find('.var-row').each(function () {
          const text = $(this).text().toLowerCase();
          const match = text.indexOf(termLower) > -1;
          $(this).toggle(match);

          // If matching, ensure parent group container is visible
          if (match) {
            $(this).parent().show();
            // Ensure header icon is correct (caret down)
            const container = $(this).parent();
            const header = container.prev();
            if (header.find('.fa-caret-right').length) {
              header.find('.fa').removeClass('fa-caret-right').addClass('fa-caret-down');
            }
          }
        });

        // Hide empty group headers/containers?
        // Let's keep it simple for now: Open all if search term exists
        if (termLower.length > 0) {
          $listContainer.find('div[style*="display:none"]').show();
          $listContainer.find('.fa-caret-right').removeClass('fa-caret-right').addClass('fa-caret-down');
        }
      };

      $searchInput.on('keyup', function () {
        filterList($(this).val());
      });

      $selectAllBtn.on('click', function () {
        $listContainer.find('.var-checkbox:visible').prop('checked', true);
      });

      $clearAllBtn.on('click', function () {
        $listContainer.find('.var-checkbox:visible').prop('checked', false);
      });

      $fetchBtn.on('click', function () {
        const configNodeId = $('#node-input-connection').val();
        const providerId = $('#node-input-providerId').val();

        if (!configNodeId || configNodeId === '_ADD_') {
          $statusMsg.text('Select Config Node!').css('color', 'red');
          return;
        }
        if (!providerId) {
          $statusMsg.text('Enter Provider ID!').css('color', 'red');
          return;
        }

        $fetchBtn.prop('disabled', true);
        $statusMsg.text('Fetching...').css('color', 'blue');
        $listContainer.html('<div style="padding:20px; text-align:center;"><i class="fa fa-spinner fa-spin"></i> Loading...</div>');

        // Headers for stateless support would go here if we had access to credentials in editor? 
        // We generally don't. But fetch providers works if deployed.

        $.ajax({
          url: 'uos/providers/' + configNodeId + '/' + providerId + '/variables?mode=read',
          success: function (data) {
            $fetchBtn.prop('disabled', false);
            $statusMsg.text('');
            currentVariables = data.sort((a, b) => {
              const idA = (a.id !== undefined) ? parseInt(a.id) : 0;
              const idB = (b.id !== undefined) ? parseInt(b.id) : 0;
              return idA - idB;
            });
            renderList(currentVariables);
            $statusMsg.text(`Loaded ${data.length} variables.`).css('color', 'green');
          },
          error: function (jqxhr) {
            $fetchBtn.prop('disabled', false);
            $statusMsg.text('Error: ' + (jqxhr.responseJSON?.error || 'Unknown')).css('color', 'red');
            $listContainer.html('<div style="padding:15px; color:#c00; text-align:center;">Failed to load variables.<br>Ensure Config is deployed.</div>');
          }
        });
      });

      // Initial Render
      const initialMap = getSelectedMap();
      if (initialMap.size > 0 && currentVariables.length === 0) {
        const dummyVars = [];
        initialMap.forEach((id, key) => dummyVars.push({ id, key }));
        renderList(dummyVars);
        $statusMsg.text('Cached selection shown. Load again to refresh.').css('color', '#888');
      } else {
        $listContainer.html('<div style="padding:20px; text-align:center; color:#999;">Click <b>Load Variables</b> to browse.</div>');
      }
    },
    oneditsave: function () {
      // 1. Save Variables
      const items = [];
      $('#variable-list-container').find('.var-checkbox').each(function () {
        if ($(this).prop('checked')) {
          const k = $(this).data('key');
          const i = $(this).data('id');
          if (k && i !== undefined && i !== 'ERR') {
            items.push(`${k}:${i}`);
          }
        }
      });
      $('#node-input-manualVariables').val(items.join(','));

      // 2. Save Polling Interval
      const val = parseInt($('#node-input-pollingInterval').val(), 10) || 0;
      const unit = $('#node-input-pollingUnit').val();
      let multiplier = 1;
      if (unit === 's') multiplier = 1000;
      if (unit === 'min') multiplier = 60000;
      const totalMs = val * multiplier;
      $('#node-input-pollingInterval').val(totalMs);
      $('#node-input-pollingUnit').val(unit);
    }
  });
</script>

<script type="text/html" data-template-name="datahub-input">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Optional">
    </div>

    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-globe"></i> Config</label>
        <input type="text" id="node-input-connection">
    </div>

    <div class="form-row">
        <label for="node-input-providerId"><i class="fa fa-server"></i> Provider ID</label>
        <div style="display:flex;">
            <input type="text" id="node-input-providerId" placeholder="e.g. u_os_adm" style="flex:1;">
            <a id="btn-lookup-provider" class="red-ui-button" style="margin-left: 5px;" title="Search Providers"><i class="fa fa-search"></i></a>
        </div>
    </div>

    <div class="form-row">
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <label><i class="fa fa-list"></i> Variables</label>
             <button id="btn-fetch-vars" class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i> Load Variables</button>
        </div>
        <div id="fetch-status" style="font-size:0.9em; min-height:1.2em; text-align:right; margin-bottom:5px;"></div>
        
        <div style="border:1px solid #ccc; padding:0; border-radius:4px; background:#fff;">
            <div style="background:#f7f7f7; padding:4px 10px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:11px; font-weight:bold;">Select Variables</span>
                <input type="text" id="node-input-var-search" placeholder="Filter..." style="width:100px; font-size:11px; padding:2px;">
            </div>
            
            <div id="variable-list-container" style="height:250px; overflow-y:auto; background:white;">
               <!-- Variables -->
            </div>

            <div style="background:#f7f7f7; padding:5px 10px; border-top:1px solid #ddd; display:flex; gap:10px;">
                <button id="btn-select-all" class="red-ui-button red-ui-button-small">All</button>
                <button id="btn-clear-all" class="red-ui-button red-ui-button-small">None</button>
                <div style="flex:1; text-align:right; color:#888; font-size:10px; padding-top:4px;">Empty selection reads ALL variables</div>
            </div>
        </div>
        <input type="hidden" id="node-input-manualVariables">
    </div>

    <div class="form-row">
        <label for="node-input-triggerMode"><i class="fa fa-bolt"></i> Trigger</label>
        <select id="node-input-triggerMode" style="width:70%;">
            <option value="event">Event (on change)</option>
            <option value="poll">Poll (interval)</option>
        </select>
    </div>

    <div id="poll-interval-row" class="form-row" style="display:none;">
        <label for="node-input-pollingInterval"><i class="fa fa-clock-o"></i> Interval</label>
        <input type="number" id="node-input-pollingInterval" style="width:80px;" placeholder="1000">
        <select id="node-input-pollingUnit" style="width:80px;">
            <option value="ms">ms</option>
            <option value="s">sec</option>
            <option value="min">min</option>
        </select>
    </div>
</script>

<script type="text/html" data-help-name="datahub-input">
    <p><b>DataHub - Read</b> reads variables from u-OS Data Hub providers.</p>
    <h3>Features</h3>
    <ul>
        <li><b>Smart Filtering:</b> Only selected variables are decoded (Filter-on-Decode), significantly reducing CPU usage.</li>
        <li><b>Grouped Selection:</b> Variables are organized by prefix (e.g., Device Name) for easier navigation.</li>
        <li><b>High Performance:</b> Enhanced buffering handles rapid data bursts reliably.</li>
    </ul>
    <h3>Configuration</h3>
    <ol>
        <li><b>Config:</b> Select your u-OS connection.</li>
        <li><b>Provider ID:</b> ID of the data source (e.g., <code>u_os_adm</code>). Use the search button to find available providers.</li>
        <li><b>Variables:</b> Click "Load Variables" to select specific data points. Leave empty to read everything.</li>
    </ol>
    <p>
        <b>Dynamic Read:</b> Send <code>msg.payload</code> as an Array of variable keys (e.g. <code>["var1", "var2"]</code>) 
        to read specific variables on demand. This overrides the node's configuration for that single request.
    </p>
</script>