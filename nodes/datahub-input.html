<script type="text/javascript">
  RED.nodes.registerType('datahub-input', {
    category: 'u-OS DataHub NATS',
    color: '#ff9900',
    defaults: {
      name: { value: "" },
      connection: { type: "uos-config", required: true },
      providerId: { value: "", required: true },
      manualVariables: { value: "" },
      triggerMode: { value: "event" },
      pollingInterval: { value: 0, validate: RED.validators.number() }
    },
    inputs: 1,
    outputs: 1,
    icon: "white/datahub-input.svg",
    label: function () {
      if (this.name) return this.name;
      return "DataHub - IN";
    },
    paletteLabel: "DataHub - IN",
    oneditprepare: function () {
      const node = this;

      // --- Trigger Mode (Event/Poll) Visibility ---
      const $triggerMode = $('#node-input-triggerMode');
      const $pollRow = $('#poll-interval-row');

      const updateTriggerVisibility = () => {
        if ($triggerMode.val() === 'poll') {
          $pollRow.show();
        } else {
          $pollRow.hide();
        }
      };

      $triggerMode.on('change', updateTriggerVisibility);
      updateTriggerVisibility();

      // --- Manual Table Logic ---
      const $manualList = $('#node-input-manual-def-list');
      const $manualHidden = $('#node-input-manualVariables');

      $manualList.editableList({
        addItem: function (row, index, data) {
          row.css({ display: 'flex', alignItems: 'center', gap: '5px' });

          $('<input/>', { class: 'node-input-manual-name', type: 'text', placeholder: 'Variable Name', style: 'flex:1;' })
            .val(data.name || '')
            .appendTo(row);

          $('<input/>', { class: 'node-input-manual-id', type: 'number', placeholder: 'ID', style: 'width:80px;' })
            .val(data.id || '')
            .appendTo(row);
        },
        removable: true,
        header: $('<div></div>').append(
          $.parseHTML('<div style="display:flex; gap:5px; padding-left:5px;"><div style="flex:1;">Variable Name (Key)</div><div style="width:80px;">ID (Number)</div></div>')
        ),
        addButton: 'Add Variable'
      });

      const currentManual = node.manualVariables || '';
      if (currentManual) {
        currentManual.split(',').forEach(entry => {
          const parts = entry.split(':');
          if (parts.length === 2) {
            const n = parts[0].trim();
            const i = parts[1].trim();
            if (n && i) $manualList.editableList('addItem', { name: n, id: i });
          }
        });
      }
    },
    oneditsave: function () {
      const $manualList = $('#node-input-manual-def-list');
      const items = [];
      $manualList.editableList('items').each(function () {
        const name = $(this).find('.node-input-manual-name').val().trim();
        const id = $(this).find('.node-input-manual-id').val().trim();
        if (name && id) {
          items.push(`${name}:${id}`);
        }
      });
      $('#node-input-manualVariables').val(items.join(','));
    }
  });
</script>

<script type="text/html" data-template-name="datahub-input">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Optional">
    </div>

    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-globe"></i> Config</label>
        <input type="text" id="node-input-connection">
    </div>

    <div class="form-row">
        <label for="node-input-providerId"><i class="fa fa-server"></i> Provider ID</label>
        <input type="text" id="node-input-providerId" placeholder="e.g. u_os_sbm">
    </div>

    <div class="form-row">
        <label><i class="fa fa-table"></i> Variables</label>
        <div style="width:100%; margin-top:8px;">
            <ol id="node-input-manual-def-list"></ol>
        </div>
        <input type="hidden" id="node-input-manualVariables">
    </div>

    <div class="form-tips">
        <i class="fa fa-info-circle"></i> Enter Variable Names and their IDs. Only these variables will be read.
    </div>

    <hr style="margin:15px 0;">

    <div class="form-row">
        <label for="node-input-triggerMode"><i class="fa fa-bolt"></i> Trigger</label>
        <select id="node-input-triggerMode">
            <option value="event">Event (on change)</option>
            <option value="poll">Poll (interval)</option>
        </select>
    </div>

    <div id="poll-interval-row" class="form-row" style="display:none;">
        <label for="node-input-pollingInterval"><i class="fa fa-clock-o"></i> Interval (ms)</label>
        <input type="number" id="node-input-pollingInterval" placeholder="e.g. 1000">
    </div>
</script>

<script type="text/html" data-help-name="datahub-input">
    <p>Reads variables from the u-OS Data Hub via NATS and outputs their values as JSON messages.</p>
    
    <h3>Quick Start</h3>
    <ol>
        <li>Select a <b>u-OS Config</b> node (create one if needed)</li>
        <li>Enter the <b>Provider ID</b> (e.g. <code>u_os_sbm</code>, <code>hub</code>)</li>
        <li>Add variables using the <b>Variables Table</b></li>
        <li>Deploy and send a message to the input port to trigger a read</li>
    </ol>

    <h3>Configuration</h3>
    
    <h4>1. Config Node</h4>
    <p>
        Select your u-OS connection settings. If you haven't created one yet, click the <b>pencil icon</b> next to "Config" to create a new uos-config node.
    </p>

    <h4>2. Provider ID</h4>
    <p>
        The name of the data source you want to read from.
    </p>
    <p><b>How to find it:</b></p>
    <ul>
        <li><b>Web UI:</b> u-Control → Data Hub → Providers → Note the Provider ID</li>
        <li><b>Python:</b> Check your <code>config.py</code> → <code>PROVIDER_ID</code></li>
        <li><b>Common examples:</b> <code>u_os_sbm</code>, <code>hub</code>, <code>custom-provider</code></li>
    </ul>

    <h4>3. Variables Table</h4>
    <p>
        Manually map variable names to their IDs. Click <b>"Add Variable"</b> for each entry.
    </p>
    
    <h5>Finding Variable IDs:</h5>
    
    <h6>Option A: From Python Config</h6>
    <pre><code>VARIABLE_DEFINITIONS = [
    {"id": 0, "key": "manufacturer_name", ...},
    {"id": 2, "key": "machine.temp", ...}
]</code></pre>
    <p>→ Use these IDs!</p>

    <h6>Option B: From u-Control Web UI</h6>
    <ol>
        <li>Go to <b>Data Hub</b> → <b>Providers</b> → Select your provider</li>
        <li>Click <b>Variables</b></li>
        <li>Note the <b>ID</b> column (usually 0, 1, 2, ...)</li>
    </ol>

    <h6>Option C: From REST API</h6>
    <pre><code>curl -H "Authorization: Bearer $TOKEN" \
  http://&lt;host&gt;/datahub/v1/providers/&lt;providerId&gt;/variables</code></pre>

    <h5>Example Table:</h5>
    <table>
        <tr><th>Variable Name</th><th>ID</th></tr>
        <tr><td><code>manufacturer_name</code></td><td>0</td></tr>
        <tr><td><code>machine.details.temp</code></td><td>2</td></tr>
    </table>

    <h4>4. Trigger Mode</h4>
    <dl>
        <dt>Event (on change) – Default</dt>
        <dd>Efficient. Outputs only when values change. Recommended for most use cases.</dd>
        
        <dt>Poll (interval)</dt>
        <dd>Forces periodic reads (e.g. every 1000ms). Use if you need guaranteed updates regardless of changes.</dd>
    </dl>

    <h3>Output Format</h3>
    <p>When triggered (via input port), the node outputs:</p>
    <pre><code>{
  "type": "snapshot",
  "variables": [
    {
      "providerId": "u_os_sbm",
      "id": 0,
      "key": "manufacturer_name",
      "value": "Weidmüller",
      "quality": "GOOD",
      "timestampNs": 1234567890000000000
    }
  ]
}</code></pre>

    <h3>Triggering Reads</h3>
    <p>
        Connect an <b>Inject</b> node to the input port. Sending any message triggers an immediate read.
    </p>
    <p>
        <b>Event Mode:</b> Also outputs automatically when values change.<br>
        <b>Poll Mode:</b> Reads at the specified interval (e.g. every 1000ms).
    </p>

    <h3>⚠️ Important: Don't Read Your Own Output Provider</h3>
    <p>
        <b>Do NOT</b> use the provider created by your <b>DataHub - OUT</b> node (e.g. <code>nodered</code>) as input.
    </p>
    <p><b>Why?</b></p>
    <ul>
        <li>The Output provider only exists <b>while Node-RED is running</b></li>
        <li>On restart, the provider disappears → Input node fails</li>
        <li>This creates a circular dependency</li>
    </ul>
    <p><b>What to use instead:</b></p>
    <ul>
        <li>Read from <b>system providers</b> (e.g. <code>u_os_sbm</code>, <code>hub</code>)</li>
        <li>Read from <b>other apps/devices</b> (not your own Node-RED)</li>
    </ul>

    <h3>Troubleshooting</h3>
    
    <h4>No Output</h4>
    <ul>
        <li>✓ Config node deployed?</li>
        <li>✓ Provider ID correct?</li>
        <li>✓ Variable IDs correct? (Check Python config or Web UI)</li>
        <li>✓ Inject signal sent to input port?</li>
    </ul>

    <h4>"Variable not found"</h4>
    <ul>
        <li>Double-check the IDs in your table</li>
        <li>Verify IDs match those in the Python config or Web UI</li>
    </ul>

    <h4>Why Manual IDs?</h4>
    <p>
        Auto-discovery requires <code>hub.variables.readonly</code> permission on the <b>provider definition endpoint</b>, 
        which is often restricted for security. The manual table works <b>without</b> this permission 
        by querying specific IDs directly.
    </p>

    <div style="margin-top:15px; padding-top:10px; border-top:1px solid #ddd; font-size:0.85em; color:#666;">
        <p><b>Developed by <a href="https://www.linkedin.com/in/iotueli/" target="_blank">IoTUeli</a></b></p>
        <p>Not an official Weidmüller product. Community contribution.</p>
    </div>
</script>