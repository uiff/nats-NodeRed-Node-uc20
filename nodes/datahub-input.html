<script type="text/javascript">
  RED.nodes.registerType('datahub-input', {
    category: 'DataHub-NATS',
    color: '#ff9f43',
    defaults: {
      name: { value: '' },
      connection: { type: 'uos-config', required: true },
      providerId: { value: '', required: true },
      variablesText: { value: '' }
    },
    inputs: 0,
    outputs: 1,
    icon: "white/datahub-input.svg",
    oneditprepare: function() {
      const node = this;
      const $config = $('#node-input-connection');
      const $providerHidden = $('#node-input-providerId');
      const $providerSelect = $('#datahub-provider-select');
      const $providerManual = $('#datahub-provider-manual');
      const $providerStatus = $('#datahub-provider-status');
      const $variablesHidden = $('#node-input-variablesText');
      const $variables = $('#datahub-input-variables');
      const $variablesStatus = $('#datahub-variables-status');

      const initialProvider = $providerHidden.val() || '';
      const initialVars = ($variablesHidden.val() || '')
        .split(',')
        .map((entry) => entry.trim())
        .filter((entry) => entry.length > 0);

      const normalizeProviders = (payload) => {
        if (!payload) {
          return [];
        }
        if (Array.isArray(payload)) {
          return payload;
        }
        if (Array.isArray(payload.providers)) {
          return payload.providers;
        }
        return [];
      };

      const normalizeVariables = (payload) => {
        if (!payload) {
          return [];
        }
        if (Array.isArray(payload)) {
          return payload;
        }
        if (Array.isArray(payload.variables)) {
          return payload.variables;
        }
        return [];
      };

      const providerLabel = (provider) => provider.name || provider.displayName || provider.providerId || provider.id || 'Unnamed provider';
      const providerValue = (provider) => provider.providerId || provider.id || provider.name || '';
      const variableValue = (variable) => variable.key || variable.name || variable.path || variable.id || '';
      const variableLabel = (variable) => variable.tagName || variable.key || variable.name || variable.path || variable.id || 'Unnamed variable';

      const syncVariablesField = () => {
        const values = $variables.val() || [];
        $variablesHidden.val(values.join(','));
      };

      let providerRequest = 0;
      let variableRequest = 0;

      const setProviderStatus = (text) => $providerStatus.text(text || '');
      const setVariableStatus = (text) => $variablesStatus.text(text || '');

      const setProviderValue = (value) => {
        $providerHidden.val(value || '');
      };

      const getProviderValue = () => $providerHidden.val() || '';

      const showManualProvider = (message) => {
        $providerSelect.hide().prop('disabled', true);
        $providerManual.show().prop('disabled', false);
        $providerManual.val(getProviderValue());
        setProviderStatus(message || 'Enter the provider ID manually.');
      };

      const showSelectProvider = () => {
        $providerManual.hide().prop('disabled', true);
        $providerSelect.show().prop('disabled', false);
      };

      const loadVariables = (providerId, keepSelection = false) => {
        const configId = $config.val();
        if (!configId || !providerId) {
          $variables.empty();
          setVariableStatus('Select a provider to load variables.');
          return;
        }
        const seq = ++variableRequest;
        setVariableStatus('Loading variables…');
        $variables.prop('disabled', true);
        $.getJSON(`uos/providers/${configId}/${encodeURIComponent(providerId)}/variables`)
          .done((payload) => {
            if (seq !== variableRequest) {
              return;
            }
            const vars = normalizeVariables(payload);
            $variables.empty();
            if (!vars.length) {
              setVariableStatus('No variables returned. Check Data Hub permissions.');
              $variables.prop('disabled', true);
              syncVariablesField();
              return;
            }
            vars.forEach((variable) => {
              const value = variableValue(variable);
              if (!value) {
                return;
              }
              const option = $('<option></option>')
                .attr('value', value)
                .text(variableLabel(variable));
              $variables.append(option);
            });
            $variables.prop('disabled', false);
            const preset = keepSelection ? ($variablesHidden.val() || '').split(',').map((entry) => entry.trim()).filter(Boolean) : initialVars;
            if (preset.length) {
              $variables.val(preset);
            }
            syncVariablesField();
            setVariableStatus('Select one or multiple variables (Ctrl/Cmd + click). Leave empty to receive all.');
          })
          .fail((xhr) => {
            const msg = xhr?.responseJSON?.error || xhr.statusText || 'Failed to load variables.';
            setVariableStatus(msg);
            $variables.prop('disabled', true);
            $variables.empty();
            syncVariablesField();
          });
      };

      const loadProviders = () => {
        const configId = $config.val();
        if (!configId) {
          $providerSelect.empty();
          $providerSelect.append('<option value="">Select a u-OS config first</option>');
          $providerSelect.prop('disabled', true);
          showManualProvider('Pick or create a u-OS config node before selecting a provider.');
          setVariableStatus('');
          $variables.empty();
          $variables.prop('disabled', true);
          return;
        }
        const seq = ++providerRequest;
        setProviderStatus('Loading providers…');
        $providerSelect.prop('disabled', true);
        showSelectProvider();
        $.getJSON(`uos/providers/${configId}`)
          .done((payload) => {
            if (seq !== providerRequest) {
              return;
            }
            const list = normalizeProviders(payload);
            $providerSelect.empty();
            if (!list.length) {
              $providerSelect.append('<option value="">No providers available</option>');
              $providerSelect.prop('disabled', true);
              setProviderStatus('No providers returned. Verify Data Hub access.');
              showManualProvider('No providers returned. Enter the ID manually if you know it.');
              return;
            }
            list.forEach((prov) => {
              const value = providerValue(prov);
              if (!value) {
                return;
              }
              const option = $('<option></option>')
                .attr('value', value)
                .text(providerLabel(prov));
              $providerSelect.append(option);
            });
            $providerSelect.prop('disabled', false);
            if (initialProvider) {
              $providerSelect.val(initialProvider);
            }
            if (!$providerSelect.val()) {
              $providerSelect.val($providerSelect.find('option:first').attr('value'));
            }
            const selected = $providerSelect.val();
            setProviderValue(selected);
            setProviderStatus('Choose the provider you want to subscribe to.');
            loadVariables(selected);
          })
          .fail((xhr) => {
            const msg = xhr?.responseJSON?.error || xhr.statusText || 'Failed to load providers.';
            showManualProvider(`Provider list failed (${msg}). Enter the provider ID manually or grant hub.variables.readonly.`);
          });
      };

      $variables.on('change', () => {
        syncVariablesField();
      });

      $providerSelect.on('change', () => {
        const value = $providerSelect.val();
        setProviderValue(value);
        $variablesHidden.val('');
        syncVariablesField();
        loadVariables(value, false);
      });

      $providerManual.on('change keyup paste', () => {
        const value = $providerManual.val();
        setProviderValue(value);
        $variablesHidden.val('');
        syncVariablesField();
        if (value) {
          loadVariables(value, false);
        }
      });

      $config.on('change', () => {
        loadProviders();
      });

      syncVariablesField();
      // Delay provider loading slightly to ensure the config typedInput is ready.
      setTimeout(() => loadProviders(), 100);
    },
    label: function () {
      return this.name || `Input ${this.providerId || ''}`;
    },
    labelStyle: function () {
      return this.name ? 'node_label_italic' : '';
    }
  });
</script>

<script type="text/html" data-template-name="datahub-input">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name">
  </div>
  <div class="form-row">
    <label for="node-input-connection"><i class="fa fa-cube"></i> u-OS Config</label>
    <input type="text" id="node-input-connection">
  </div>
  <div class="form-row">
    <label><i class="fa fa-id-badge"></i> Provider</label>
    <div style="flex:1;">
      <select id="datahub-provider-select" style="width:100%;"></select>
      <input type="text" id="datahub-provider-manual" placeholder="provider id" style="width:100%; display:none;">
      <input type="hidden" id="node-input-providerId">
    </div>
  </div>
  <div class="form-row">
    <label></label>
    <div id="datahub-provider-status" class="form-tips"></div>
  </div>
  <div class="form-row">
    <label for="datahub-input-variables"><i class="fa fa-list"></i> Variables</label>
    <div style="flex:1;">
      <select id="datahub-input-variables" multiple size="6" style="width:100%;"></select>
      <input type="hidden" id="node-input-variablesText">
    </div>
  </div>
  <div class="form-row">
    <label></label>
    <div id="datahub-variables-status" class="form-tips">Leave empty to listen to every variable.</div>
  </div>
</script>

<script type="text/html" data-help-name="datahub-input">
  <p><strong>DataHub Input</strong> subscribes to a provider via the u-OS Data Hub and emits JSON messages.</p>
  <dl>
    <dt>u-OS Config</dt>
    <dd>Pick the connection node that holds host, port and OAuth credentials.</dd>
    <dt>Provider ID</dt>
    <dd>Provider to read. The drop-down lists every provider returned by the Control Center REST API.</dd>
    <dt>Variables</dt>
    <dd>Select one or more variable keys (single/multi-select). Leave unselected to stream all variables from the provider.</dd>
  </dl>
  <p>Each message has <code>msg.payload</code> shaped like:</p>
<pre>{
  "type": "snapshot" | "change",
  "variables": [
    { "name": "diagnostics.status_text", "value": "ready" }
  ]
}</pre>
</script>
