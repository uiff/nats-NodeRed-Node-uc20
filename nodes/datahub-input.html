<script type="text/javascript">
  RED.nodes.registerType('datahub-input', {
    category: 'DataHub-NATS',
    color: '#ff9f43',
    defaults: {
      name: { value: '' },
      connection: { type: 'uos-config', required: true },
      providerId: { value: '', required: false },
      variablesText: { value: '', required: false },
      pollingInterval: { value: 0, required: false, validate: RED.validators.number() },
    },
    inputs: 0,
    outputs: 1,
    icon: "white/datahub-input.svg",
    oneditprepare: function () {
      const node = this;
      const $config = $('#node-input-connection');
      const $providerHidden = $('#node-input-providerId');
      const $providerSelect = $('#datahub-provider-select');
      const $providerManual = $('#datahub-provider-manual');
      const $providerRefresh = $('#datahub-provider-refresh');
      const $providerStatus = $('#datahub-provider-status');

      const $variablesHidden = $('#node-input-variablesText');
      const $variables = $('#datahub-input-variables'); // Note: This selector might be wrong in previous code, checking container
      const $variablesContainer = $('#datahub-variables-container');
      const $varsRefresh = $('#datahub-vars-refresh');
      const $variablesStatus = $('#datahub-variables-status');

      const initialProvider = $providerHidden.val() || '';
      const initialVars = ($variablesHidden.val() || '')
        .split(',')
        .map((entry) => entry.trim())
        .filter((entry) => entry.length > 0);

      const normalizeProviders = (payload) => {
        console.log('normalizeProviders payload:', payload);
        if (!payload) {
          return [];
        }
        if (Array.isArray(payload)) {
          return payload;
        }
        if (Array.isArray(payload.providers)) {
          return payload.providers;
        }
        return [];
      };

      const normalizeVariables = (payload) => {
        console.log('normalizeVariables payload:', payload);
        if (!payload) {
          return [];
        }
        if (Array.isArray(payload)) {
          return payload;
        }
        if (Array.isArray(payload.variables)) {
          return payload.variables;
        }
        return [];
      };

      // API returns [{ "id": "..." }] for providers
      const providerLabel = (provider) => provider.displayName || provider.name || provider.id || provider.providerId || 'Unnamed provider';
      const providerValue = (provider) => provider.id || provider.providerId || provider.name || '';

      // API returns [{ "key": "..." }] for variables
      const variableValue = (variable) => variable.key || variable.name || variable.path || variable.id || '';
      const variableLabel = (variable) => variable.tagName || variable.key || variable.name || variable.path || variable.id || 'Unnamed variable';

      const syncVariablesField = () => {
        const values = $variables.val() || [];
        $variablesHidden.val(values.join(','));
      };

      let providerRequest = 0;
      let variableRequest = 0;

      const setProviderStatus = (text) => $providerStatus.text(text || '');
      const setVariableStatus = (text) => $variablesStatus.text(text || '');

      const setProviderValue = (value) => {
        $providerHidden.val(value || '');
      };

      const getProviderValue = () => $providerHidden.val() || '';

      const showManualProvider = (message) => {
        $providerSelect.hide().prop('disabled', true);
        $providerManual.show().prop('disabled', false);
        $providerManual.val(getProviderValue());
        setProviderStatus(message || 'Enter the provider ID manually.');
      };

      const showSelectProvider = () => {
        $providerManual.hide().prop('disabled', true);
        $providerSelect.show().prop('disabled', false);
      };

      const loadVariables = (providerId, keepSelection = false) => {
        const configId = $config.val();
        if (!configId || !providerId) {
          $variables.empty();
          setVariableStatus('Select a provider to load variables.');
          return;
        }
        const seq = ++variableRequest;
        setVariableStatus('Loading variables…');
        $variables.prop('disabled', true);
        $.getJSON(`uos/providers/${configId}/${encodeURIComponent(providerId)}/variables`)
          .done((payload) => {
            if (seq !== variableRequest) {
              return;
            }
            const vars = normalizeVariables(payload);
            $variables.empty();
            if (!vars.length) {
              setVariableStatus('No variables returned. Check Data Hub permissions.');
              $variables.prop('disabled', true);
              syncVariablesField();
              return;
            }
            vars.forEach((variable) => {
              const value = variableValue(variable);
              if (!value) {
                return;
              }
              const option = $('<option></option>')
                .attr('value', value)
                .text(variableLabel(variable));
              $variables.append(option);
            });
            $variables.prop('disabled', false);
            const preset = keepSelection ? ($variablesHidden.val() || '').split(',').map((entry) => entry.trim()).filter(Boolean) : initialVars;
            if (preset.length) {
              $variables.val(preset);
            }
            syncVariablesField();
            setVariableStatus('Select one or multiple variables (Ctrl/Cmd + click). Leave empty to receive all.');
          })
          .fail((xhr) => {
            console.error('Variable load failed', xhr);
            const error = xhr?.responseJSON?.error;
            let msg = error || xhr.statusText || 'Failed to load variables.';
            if (xhr.status === 404 && error === 'config not found') {
              msg = 'Config not deployed yet. Please Deploy first.';
            }
            setVariableStatus(msg);
            $variablesContainer.empty().append('<div style="color:#aaa; font-style:italic; padding:5px;">Error loading variables.</div>');
            $variables.prop('disabled', true);
            syncVariablesField();
          });
      };

      const loadProviders = (force = false) => {
        const configId = $config.val();
        if (!configId) {
          $providerSelect.empty().append('<option value="">Select a u-OS config first</option>').prop('disabled', true);
          setVariableStatus('');
          $variablesContainer.empty().append('<div style="color:#aaa; font-style:italic; padding:5px;">Select a provider to load variables...</div>');
          return;
        }

        const seq = ++providerRequest;

        // Use cache only if not forced
        if (!force && window.uOSProvidersCache && window.uOSProvidersCache[configId]) {
          console.log('Using cached providers for', configId);
          setTimeout(() => {
            if (seq === providerRequest) populateProviders(window.uOSProvidersCache[configId]);
          }, 0);
          return;
        }

        setProviderStatus('Loading providers…');
        $providerSelect.prop('disabled', true);
        // Removed showManualProvider/showSelectProvider logic - always assume Select

        $.getJSON(`uos/providers/${configId}`)
          .done((payload) => {
            if (seq !== providerRequest) return;
            // Update cache on success
            const list = normalizeProviders(payload);
            if (window.uOSProvidersCache) window.uOSProvidersCache[configId] = list;
            populateProviders(payload);
          })
          .fail((xhr) => {
            console.error('Provider load failed', xhr);
            const error = xhr?.responseJSON?.error;
            let msg = error || xhr.statusText || 'Failed to load providers.';
            if (xhr.status === 404 && error === 'config not found') {
              msg = 'Config not deployed yet. Please use "Test Connection" in Config Node or Deploy first.';
            }
            $providerSelect.empty().append('<option value="">Error loading providers</option>').prop('disabled', true);
            setProviderStatus(`Error: ${msg} - Click Refresh to retry.`);
            // Do NOT switch to manual input
          });
      };

      const populateProviders = (payload) => {
        const list = normalizeProviders(payload);
        $providerSelect.empty();
        if (!list.length) {
          $providerSelect.append('<option value="">No providers found</option>').prop('disabled', true);
          setProviderStatus('No providers found. Verify Data Hub access.');
          return;
        }
        let foundInitial = false;
        list.forEach((prov) => {
          const value = providerValue(prov);
          if (!value) return;
          const option = $('<option></option>').attr('value', value).text(providerLabel(prov));
          $providerSelect.append(option);
          if (value === initialProvider) foundInitial = true;
        });
        $providerSelect.prop('disabled', false);

        if (initialProvider && foundInitial) {
          $providerSelect.val(initialProvider);
        } else if (initialProvider) {
          // Valid case: provider set but not in list? Or manual override needed?
          // User said "no input", so we just show what we have. 
          // Optionally add the current unknown provider as an option
          $providerSelect.append($('<option></option>').attr('value', initialProvider).text(initialProvider + ' (unknown)'));
          $providerSelect.val(initialProvider);
        }

        // Select first if nothing selected
        if (!$providerSelect.val()) {
          $providerSelect.val($providerSelect.find('option:first').attr('value'));
        }

        const selected = $providerSelect.val();
        setProviderValue(selected);
        setProviderStatus('');
        loadVariables(selected, false); // Reload vars for selected
      };

      $variables.on('change', () => {
        syncVariablesField();
      });

      $providerSelect.on('change', () => {
        const value = $providerSelect.val();
        setProviderValue(value);
        $variablesHidden.val('');
        syncVariablesField();
        loadVariables(value, false);
      });

      $providerRefresh.on('click', () => {
        loadProviders(true); // Force refresh
      });

      $varsRefresh.on('click', () => {
        const prov = $providerSelect.val();
        if (prov) loadVariables(prov, true);
      });

      // Removed $providerManual listeners as per instruction

      $config.on('change', () => {
        loadProviders(false);
      });

      syncVariablesField();
      // Delay provider loading slightly to ensure the config typedInput is ready.
      setTimeout(() => loadProviders(), 100);
    },
    label: function () {
      return this.name || `Input ${this.providerId || ''}`;
    },
    labelStyle: function () {
      return this.name ? 'node_label_italic' : '';
    }
  });
</script>

<script type="text/html" data-template-name="datahub-input">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name">
  </div>
  <div class="form-row">
    <label for="node-input-connection"><i class="fa fa-cube"></i> u-OS Config</label>
    <input type="text" id="node-input-connection">
  </div>
  <div class="form-row">
    <label><i class="fa fa-id-badge"></i> Provider</label>
    <div style="display:flex; align-items:center; flex:1; gap:5px;">
      <select id="datahub-provider-select" style="flex:1;"></select>
      <button type="button" id="datahub-provider-refresh" class="red-ui-button" title="Refresh Providers"><i class="fa fa-refresh"></i></button>
      <input type="hidden" id="node-input-providerId">
      <!-- Manual input fallback kept hidden/removed from flow per user request -->
      <input type="text" id="datahub-provider-manual" style="display:none;" disabled>
    </div>
  </div>
  <div class="form-row">
    <label></label>
    <div id="datahub-provider-status" class="form-tips"></div>
  </div>
  <div class="form-row">
    <label for="datahub-input-variables"><i class="fa fa-list"></i> Variables</label>
    <div style="display:flex; align-items:center; flex:1; margin-bottom:5px;">
        <span style="flex:1"></span>
        <button type="button" id="datahub-vars-refresh" class="red-ui-button red-ui-button-small" title="Refresh Variables"><i class="fa fa-refresh"></i></button>
    </div>
  </div>
  <div class="form-row">
    <label></label>
    <div style="border:1px solid #ccc; border-radius:4px; height:150px; overflow-y:scroll; padding:5px; margin-left:105px;" id="datahub-variables-container">
       <!-- Checkboxes will be inserted here -->
       <div style="color:#aaa; font-style:italic; padding:5px;">Select a provider to load variables...</div>
    </div>
    <input type="hidden" id="node-input-variablesText">
  </div>
  <div class="form-row">
    <label></label>
    <div id="datahub-variables-status" class="form-tips">Leave empty to listen to every variable.</div>
  </div>
</script>

<script type="text/html" data-help-name="datahub-input">
  <p><strong>DataHub Input</strong> subscribes to a provider via the u-OS Data Hub and emits JSON messages.</p>
  <p><em>Note: This node is developed by <strong>iotueli</strong> and is NOT an official Weidmüller product.</em></p>
  <dl>
    <dt>u-OS Config</dt>
    <dd>Pick the connection node that holds host, port and OAuth credentials.</dd>
    <dt>Provider ID</dt>
    <dd>Provider to read. The drop-down lists every provider returned by the Control Center REST API.</dd>
    <dt>Variables</dt>
    <dd>Select one or more variable keys (single/multi-select). Leave unselected to stream all variables from the provider.</dd>
  </dl>
  <p>Each message has <code>msg.payload</code> shaped like:</p>
<pre>{
  "type": "snapshot" | "change",
  "variables": [
    { "name": "diagnostics.status_text", "value": "ready" }
  ]
}</pre>
</script>