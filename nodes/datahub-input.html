<script type="text/javascript">
  RED.nodes.registerType('datahub-input', {
    category: 'u-OS DataHub NATS',
    color: '#ff9900',
    defaults: {
      name: { value: "" },
      connection: { type: "uos-config", required: true },
      providerId: { value: "", required: true },
      manualVariables: { value: "" },
      triggerMode: { value: "event" },
      pollingInterval: { value: 0, validate: RED.validators.number() }
    },
    inputs: 1,
    outputs: 1,
    icon: "white/datahub-input.svg",
    label: function () {
      if (this.name) return this.name;
      return "DataHub - IN";
    },
    paletteLabel: "DataHub - IN",
    oneditprepare: function () {
      const node = this;

      // --- Trigger Mode (Event/Poll) Visibility ---
      const $triggerMode = $('#node-input-triggerMode');
      const $pollRow = $('#poll-interval-row');

      const updateTriggerVisibility = () => {
        if ($triggerMode.val() === 'poll') {
          $pollRow.show();
        } else {
          $pollRow.hide();
        }
      };

      $triggerMode.on('change', updateTriggerVisibility);
      updateTriggerVisibility();

      // --- Manual Table Logic ---
      const $manualList = $('#node-input-manual-def-list');
      const $manualHidden = $('#node-input-manualVariables');

      $manualList.editableList({
        addItem: function (row, index, data) {
          row.css({ display: 'flex', alignItems: 'center', gap: '5px' });

          $('<input/>', { class: 'node-input-manual-name', type: 'text', placeholder: 'Variable Name', style: 'flex:1;' })
            .val(data.name || '')
            .appendTo(row);

          $('<input/>', { class: 'node-input-manual-id', type: 'number', placeholder: 'ID', style: 'width:80px;' })
            .val(data.id || '')
            .appendTo(row);
        },
        removable: true,
        header: $('<div></div>').append(
          $.parseHTML('<div style="display:flex; gap:5px; padding-left:5px;"><div style="flex:1;">Variable Name (Key)</div><div style="width:80px;">ID (Number)</div></div>')
        ),
        addButton: 'Add Variable'
      });

      const currentManual = node.manualVariables || '';
      if (currentManual) {
        currentManual.split(',').forEach(entry => {
          const parts = entry.split(':');
          if (parts.length === 2) {
            const n = parts[0].trim();
            const i = parts[1].trim();
            if (n && i) $manualList.editableList('addItem', { name: n, id: i });
          }
        });
      }
    },
    oneditsave: function () {
      const $manualList = $('#node-input-manual-def-list');
      const items = [];
      $manualList.editableList('items').each(function () {
        const name = $(this).find('.node-input-manual-name').val().trim();
        const id = $(this).find('.node-input-manual-id').val().trim();
        if (name && id) {
          items.push(`${name}:${id}`);
        }
      });
      $('#node-input-manualVariables').val(items.join(','));
    }
  });
</script>

<script type="text/html" data-template-name="datahub-input">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Optional">
    </div>

    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-globe"></i> Config</label>
        <input type="text" id="node-input-connection">
    </div>

    <div class="form-row">
        <label for="node-input-providerId"><i class="fa fa-server"></i> Provider ID</label>
        <input type="text" id="node-input-providerId" placeholder="e.g. u_os_sbm">
    </div>

    <div class="form-row">
        <label><i class="fa fa-table"></i> Variables</label>
        <div style="width:100%; margin-top:8px;">
            <ol id="node-input-manual-def-list"></ol>
        </div>
        <input type="hidden" id="node-input-manualVariables">
    </div>

    <div class="form-tips">
        <i class="fa fa-info-circle"></i> Enter Variable Names and their IDs. Only these variables will be read.
    </div>

    <hr style="margin:15px 0;">

    <div class="form-row">
        <label for="node-input-triggerMode"><i class="fa fa-bolt"></i> Trigger</label>
        <select id="node-input-triggerMode">
            <option value="event">Event (on change)</option>
            <option value="poll">Poll (interval)</option>
        </select>
    </div>

    <div id="poll-interval-row" class="form-row" style="display:none;">
        <label for="node-input-pollingInterval"><i class="fa fa-clock-o"></i> Interval (ms)</label>
        <input type="number" id="node-input-pollingInterval" placeholder="e.g. 1000">
    </div>
</script>

<script type="text/html" data-help-name="datahub-input">
    <p>Reads variables from the u-OS Data Hub via NATS.</p>
    
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>Provider ID</dt>
        <dd>The Data Hub Provider ID (e.g. <code>u_os_sbm</code>, <code>hub</code>)</dd>
        
        <dt>Variables</dt>
        <dd>
            Manual mapping of Variable Names to IDs. Each row specifies:
            <ul>
                <li><b>Variable Name:</b> The key/path (e.g. <code>manufacturer_name</code>)</li>
                <li><b>ID:</b> The numeric ID from the Data Hub</li>
            </ul>
            Only variables listed here will be output.
        </dd>
        
        <dt>Trigger</dt>
        <dd>
            <ul>
                <li><b>Event:</b> Outputs only when value changes (default, efficient)</li>
                <li><b>Poll:</b> Queries values at fixed interval (less efficient)</li>
            </ul>
        </dd>
    </dl>
    
    <h3>Finding Variable IDs</h3>
    <p>
        You can find Variable IDs using:
        <ul>
            <li>The u-Control Web Interface</li>
            <li>REST API: <code>GET /datahub/v1/providers/{providerId}/variables</code></li>
            <li>NATS query tools</li>
        </ul>
    </p>

    <div style="margin-top:10px; font-size:0.8em; color:#666; border-top:1px solid #eee; padding-top:5px;">
        Developed by <a href="https://github.com/iotueli" target="_blank">iotueli</a>. Not an official Weidm√ºller product.
    </div>
</script>