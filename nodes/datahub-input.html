<script type="text/javascript">
  RED.nodes.registerType('datahub-input', {
    category: 'Weidmueller DataHub',
    color: '#ff9900',
    defaults: {
      name: { value: "" },
      connection: { type: "uos-config", required: true },
      providerId: { value: "", required: true },
      manualVariables: { value: "" },
      triggerMode: { value: "event" },
      pollingInterval: { value: 0, validate: RED.validators.number() },
      pollingUnit: { value: "ms" }
    },
    inputs: 1,
    outputs: 1,
    icon: "datahub-read.svg",
    label: function () {
      if (this.name) return this.name;
      return "DataHub - Read";
    },
    paletteLabel: "DataHub - Read",
    oneditprepare: function () {
      const node = this;

      // --- Trigger Mode & Polling Logic ---
      const $triggerMode = $('#node-input-triggerMode');
      const $pollRow = $('#poll-interval-row');
      const $pollIntInput = $('#node-input-pollingInterval');
      const $pollUnitInput = $('#node-input-pollingUnit');

      // Convert stored ms to unit for display
      let currentMs = node.pollingInterval || 0;
      let uiVal = currentMs;
      let uiUnit = node.pollingUnit || 'ms';

      // Heuristic helper if unit was missing (legacy support)
      if (!node.pollingUnit && currentMs > 0) {
        if (currentMs >= 60000 && currentMs % 60000 === 0) { uiVal = currentMs / 60000; uiUnit = 'min'; }
        else if (currentMs >= 1000 && currentMs % 1000 === 0) { uiVal = currentMs / 1000; uiUnit = 's'; }
      }
      $pollUnitInput.val(uiUnit);
      $pollIntInput.val(uiVal);

      const updateTriggerVisibility = () => {
        if ($triggerMode.val() === 'poll') {
          $pollRow.show();
        } else {
          $pollRow.hide();
        }
      };

      $triggerMode.on('change', updateTriggerVisibility);
      updateTriggerVisibility();

      // --- Variable Selector Logic ---
      const $fetchBtn = $('#btn-fetch-vars');
      const $listContainer = $('#variable-list-container');
      const $statusMsg = $('#fetch-status');
      const $searchInput = $('#node-input-var-search');
      const $selectAllBtn = $('#btn-select-all');
      const $clearAllBtn = $('#btn-clear-all');
      const $hiddenManual = $('#node-input-manualVariables');

      // Styles
      // Adjusted: ID column removed per user request (Key is main identifier)
      const rowStyle = "display:grid; grid-template-columns: 30px 1fr; align-items:center; padding:4px 0; border-bottom:1px solid #eee; font-family:'Helvetica Neue', Arial, sans-serif; font-size:12px;";
      // const idStyle = ... (removed)
      const keyStyle = "overflow:hidden; text-overflow:ellipsis; white-space:nowrap; padding-left:10px;";

      let currentVariables = []; // Stores {id, key, accessType, etc.}

      // Parse existing selection
      const getSelectedMap = () => {
        const selected = new Map(); // Key -> ID
        const raw = $hiddenManual.val();
        if (raw) {
          raw.split(',').forEach(entry => {
            const parts = entry.split(':');
            if (parts.length === 2) {
              selected.set(parts[0].trim(), parts[1].trim());
            }
          });
        }
        return selected;
      };

      const renderList = (vars) => {
        $listContainer.empty();
        if (!vars || vars.length === 0) {
          $listContainer.append('<div style="padding:15px; color:#777; text-align:center;">No variables found.</div>');
          return;
        }

        const selectedMap = getSelectedMap();

        vars.forEach(v => {
          // Robust ID handling
          let rawId = (v.id !== undefined && v.id !== null) ? v.id : v.Id;
          const safeId = (rawId !== undefined && rawId !== null) ? rawId : 'ERR';
          const isSelected = selectedMap.has(v.key);

          const row = $('<div>', { class: 'var-row', style: rowStyle });

          const cbContainer = $('<div>', { style: 'text-align:center;' });
          const cb = $('<input type="checkbox" class="var-checkbox">')
            .prop('checked', isSelected)
            .data('key', v.key)
            .data('id', safeId); // ID strictly stored in data attribute
          cbContainer.append(cb);

          // ID Column Removed from View
          // const idBadge = ...

          const label = $('<div>', { style: keyStyle, title: v.key }).text(v.key);

          row.append(cbContainer).append(label); // No ID badge
          $listContainer.append(row);
        });
      };

      const filterList = (term) => {
        const rows = $listContainer.find('.var-row');
        term = term.toLowerCase();
        rows.each(function () {
          const text = $(this).find('div:nth-child(3)').text().toLowerCase(); // 3rd child is name
          $(this).toggle(text.indexOf(term) > -1);
        });
      };

      $searchInput.on('keyup', function () {
        filterList($(this).val());
      });

      $selectAllBtn.on('click', function () {
        $listContainer.find('.var-checkbox:visible').prop('checked', true);
      });

      $clearAllBtn.on('click', function () {
        $listContainer.find('.var-checkbox:visible').prop('checked', false);
      });

      $fetchBtn.on('click', function () {
        const configNodeId = $('#node-input-connection').val();
        const providerId = $('#node-input-providerId').val();

        if (!configNodeId || configNodeId === '_ADD_') {
          $statusMsg.text('Select Config Node!').css('color', 'red');
          return;
        }
        if (!providerId) {
          $statusMsg.text('Enter Provider ID!').css('color', 'red');
          return;
        }

        $fetchBtn.prop('disabled', true);
        $statusMsg.text('Fetching...').css('color', 'blue');
        $listContainer.html('<div style="padding:20px; text-align:center;"><i class="fa fa-spinner fa-spin"></i> Loading...</div>');

        $.getJSON('uos/providers/' + configNodeId + '/' + providerId + '/variables', function (data) {
          $fetchBtn.prop('disabled', false);
          $statusMsg.text('');
          // Sort by ID (handle 'id' or 'Id')
          currentVariables = data.sort((a, b) => {
            const idA = (a.id !== undefined) ? a.id : a.Id;
            const idB = (b.id !== undefined) ? b.id : b.Id;
            return parseInt(idA) - parseInt(idB);
          });
          renderList(currentVariables);
          $statusMsg.text(`Loaded ${data.length} variables.`).css('color', 'green');
        }).fail(function (jqxhr) {
          $fetchBtn.prop('disabled', false);
          $statusMsg.text('Error: ' + (jqxhr.responseJSON?.error || 'Unknown')).css('color', 'red');
          $listContainer.empty();
        });
      });

      // Initial Render
      const initialMap = getSelectedMap();
      if (initialMap.size > 0 && currentVariables.length === 0) {
        const dummyVars = [];
        initialMap.forEach((id, key) => dummyVars.push({ id, key }));
        // Just in case stored ID is undefined, show it so user can see it's broken
        renderList(dummyVars);
        $statusMsg.text('Cached variables shown. Load again to refresh.').css('color', '#888');
      } else {
        $listContainer.html('<div style="padding:20px; text-align:center; color:#999;">Start by clicking <b>Load Variables</b>.<br><br>Empty Selection = <b>Read ALL</b></div>');
      }
    },
    oneditsave: function () {
      // 1. Save Variables
      const items = [];
      $('#variable-list-container').find('.var-checkbox').each(function () {
        if ($(this).prop('checked')) {
          const k = $(this).data('key');
          const i = $(this).data('id');
          // Important: Don't save if ID is 'ERR' or undefined
          if (k && i !== undefined && i !== 'ERR') {
            items.push(`${k}:${i}`);
          }
        }
      });
      $('#node-input-manualVariables').val(items.join(','));

      // 2. Save Polling Interval (calculate ms)
      const val = parseInt($('#node-input-pollingInterval').val(), 10) || 0;
      const unit = $('#node-input-pollingUnit').val();
      let multiplier = 1;
      if (unit === 's') multiplier = 1000;
      if (unit === 'min') multiplier = 60000;

      // We overwrite the raw value with calculated MS. 
      // WAIT! The 'defaults' define pollingInterval. If we overwrite it here, the UI input needs to read it back correctly in oneditprepare.
      // Actually, standard pattern is to store the MS value in 'pollingInterval' and recover the Unit in UI.
      // But my oneditprepare logic for unit recovery was heuristic. Let's make it robust by trusting the calculation.
      const totalMs = val * multiplier;
      $('#node-input-pollingInterval').val(totalMs);
      $('#node-input-pollingUnit').val(unit); // Also save the unit
    }
  });
</script>

<script type="text/html" data-template-name="datahub-input">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Optional">
    </div>

    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-globe"></i> Config</label>
        <input type="text" id="node-input-connection">
    </div>

    <div class="form-row">
        <label for="node-input-providerId"><i class="fa fa-server"></i> Provider ID</label>
        <div style="display:flex; gap:5px;">
            <input type="text" id="node-input-providerId" placeholder="e.g. u_os_adm" style="flex:1;">
            <button id="btn-fetch-vars" class="red-ui-button"><i class="fa fa-refresh"></i> Load Variables</button>
        </div>
        <div id="fetch-status" style="margin-top:5px; font-size:0.9em; min-height:1.2em;"></div>
    </div>

    <div class="form-row" style="border:1px solid #ccc; padding:0; border-radius:4px; background:#fff;">
        <div style="background:#f7f7f7; padding:8px 10px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold; font-size:12px;"><i class="fa fa-list-ul"></i> Selection</span>
            <input type="text" id="node-input-var-search" placeholder="Filter..." style="width:120px; font-size:11px; padding:2px;">
        </div>
        
        <div style="display:grid; grid-template-columns: 30px 1fr; background:#eee; font-size:11px; font-weight:bold; padding:4px 0; border-bottom:1px solid #ccc;">
            <div style="text-align:center;"><i class="fa fa-check-square-o"></i></div>
            <!-- ID Column Removed -->
            <div style="padding-left:10px;">Name</div>
        </div>

        <div id="variable-list-container" style="height:250px; overflow-y:auto; background:white;">
           <!-- Variables -->
        </div>

        <div style="background:#f7f7f7; padding:8px 10px; border-top:1px solid #ddd; display:flex; gap:10px;">
            <button id="btn-select-all" class="red-ui-button red-ui-button-small">Select All</button>
            <button id="btn-clear-all" class="red-ui-button red-ui-button-small">Clear All</button>
            <div style="flex:1; text-align:right; color:#888; font-size:11px; padding-top:4px;">Empty = Read ALL</div>
        </div>
        <input type="hidden" id="node-input-manualVariables">
    </div>

    <hr style="margin:15px 0;">

    <div class="form-row">
        <label for="node-input-triggerMode"><i class="fa fa-bolt"></i> Trigger</label>
        <select id="node-input-triggerMode" style="width:70%;">
            <option value="event">Event (on change)</option>
            <option value="poll">Poll (interval)</option>
        </select>
    </div>

    <div id="poll-interval-row" class="form-row" style="display:none;">
        <label for="node-input-pollingInterval"><i class="fa fa-clock-o"></i> Interval</label>
        <input type="number" id="node-input-pollingInterval" style="width:80px;" placeholder="1000">
        <select id="node-input-pollingUnit" style="width:80px;">
            <option value="ms">ms</option>
            <option value="s">sec</option>
            <option value="min">min</option>
        </select>
    </div>
</script>

<script type="text/html" data-help-name="datahub-input">
    <p><b>DataHub - Read</b> reads variables from u-OS Data Hub providers and outputs their values as JSON messages.</p>
    
    <h3>Quick Start</h3>
    <ol>
        <li>Select a <b>u-OS Config</b> node (create one if needed)</li>
        <li>Enter the <b>Provider ID</b> (e.g. <code>u_os_adm</code>)</li>
        <li>Add variables using the <b>Variables Table</b></li>
        <li>Deploy and send a message to the input port to trigger a read</li>
    </ol>

    <h3>Configuration</h3>
    
    <h4>1. Config Node</h4>
    <p>
        Select your u-OS connection settings. If you haven't created one yet, click the <b>pencil icon</b> next to "Config" to create a new uos-config node.
    </p>

    <h4>2. Provider ID</h4>
    <p>
        The name of the data source you want to read from.
    </p>
    <p><b>How to find it:</b></p>
    <ul>
        <li><b>Web UI:</b> u-Control → Data Hub → Providers → Note the Provider ID</li>
        <li><b>Common examples:</b> <code>u_os_adm</code>, <code>hub</code>, <code>custom-provider</code></li>
    </ul>

    <h4>3. Variables Table</h4>
    <p>
        Use the <b>Load Variables</b> button to browse and select variables from the provider.
        Selected variables are automatically added to the list.
    </p>
    <p>
        The table maps Variable Keys (names) to their IDs.
    </p>
    
    <h5>Manual Entry (Fallback)</h5>
    <p>
        If the "Load Variables" feature is unavailable, you can manually add variables knowing their IDs:
    </p>
    <ul>
        <li><b>Variable Key:</b> The name (e.g. <code>machine.temp</code>)</li>
        <li><b>Variable ID:</b> The numeric ID (e.g. <code>5</code>)</li>
    </ul>

    <h4>4. Trigger Mode</h4>
    <dl>
        <dt>Event (on change) – Default</dt>
        <dd>Efficient. Outputs only when values change. Recommended for most use cases.</dd>
        
        <dt>Poll (interval)</dt>
        <dd>Forces periodic reads (e.g. every 1000ms). Use if you need guaranteed updates regardless of changes.</dd>
    </dl>

    <h3>Output Format</h3>
    <p>When triggered (via input port), the node outputs:</p>
    <pre><code>{
  "type": "snapshot",
  "variables": [
    {
      "providerId": "u_os_adm",
      "id": 0,
      "key": "manufacturer_name",
      "value": "Weidmüller",
      "quality": "GOOD",
      "timestampNs": 1234567890000000000
    }
  ]
}</code></pre>

    <h3>Triggering Reads</h3>
    <p>
        Connect an <b>Inject</b> node to the input port. Sending any message triggers an immediate read.
    </p>
    <p>
        <b>Event Mode:</b> Also outputs automatically when values change.<br>
        <b>Poll Mode:</b> Reads at the specified interval (e.g. every 1000ms).
    </p>

    <h3>⚠️ Important: Don't Read Your Own Output Provider</h3>
    <p>
        <b>Do NOT</b> use the provider created by your <b>DataHub - OUT</b> node (e.g. <code>nodered</code>) as input.
    </p>
    <p><b>Why?</b></p>
    <ul>
        <li>The Output provider only exists <b>while Node-RED is running</b></li>
        <li>On restart, the provider disappears → Input node fails</li>
        <li>This creates a circular dependency</li>
    </ul>
    <p><b>What to use instead:</b></p>
    <ul>
        <li>Read from <b>system providers</b> (e.g. <code>u_os_adm</code>, <code>hub</code>)</li>
        <li>Read from <b>other apps/devices</b> (not your own Node-RED)</li>
    </ul>

    <h3>Troubleshooting</h3>
    
    <h4>No Output</h4>
    <ul>
        <li>✓ Config node deployed?</li>
        <li>✓ Provider ID correct?</li>
        <li>✓ Variable IDs correct?</li>
        <li>✓ Inject signal sent to input port?</li>
    </ul>

    <h4>"Variable not found"</h4>
    <ul>
        <li>Double-check the IDs in your table</li>
        <li>Verify IDs match those in the Python config or Web UI</li>
    </ul>

    <div style="margin-top:15px; padding-top:10px; border-top:1px solid #ddd; font-size:0.85em; color:#666;">
        <p><b>Developed by <a href="https://www.linkedin.com/in/iotueli/" target="_blank">IoTUeli</a></b></p>
        <p>Not an official Weidmüller product. Community contribution.</p>
    </div>
</script>