<script type="text/javascript">
  RED.nodes.registerType('datahub-output', {
    category: 'Weidmueller DataHub',
    color: '#ff9900',
    defaults: {
      name: { value: '' },
      connection: { type: 'uos-config', required: true },
      providerId: { value: '', required: false },
      heartbeatInterval: { value: 300, required: true, validate: RED.validators.number() } // Default 5 mins
    },
    inputs: 1,
    outputs: 1,
    icon: "datahub-provider.svg",
    oneditprepare: function () {
      const node = this;
      const $conn = $('#node-input-connection');
      const $provIdInput = $('#node-input-providerId');

      // Create UI elements dynamically if they don't exist in template
      // Wrapper for the specific UI
      const $wrapper = $('<div style="display:inline-block; width:70%;"></div>').insertAfter($('label[for="node-input-providerId"]'));

      // 1. Display Mode Elements
      const $displayGroup = $('<div id="prov-id-display-group" style="display:none; align-items:center;"></div>').appendTo($wrapper);
      // Styled like a read-only input but cleaner
      const $displayText = $('<span id="prov-id-display-text" style="flex-grow:1; padding:6px; background:#f9f9f9; border:1px solid #ccc; border-radius:4px; color:#333;">nodered</span>').appendTo($displayGroup);

      // User requested to remove the edit pencil ("es ist nur eine Anzeige!")
      // const $editBtn = ... (removed)

      // 2. Input Mode Elements
      const $inputGroup = $('<div id="prov-id-input-group" style="display:none; align-items:center;"></div>').appendTo($wrapper);
      // Move existing input into this group
      $provIdInput.css('width', '100%').css('flex-grow', '1').appendTo($inputGroup);
      const $resetBtn = $('<a class="red-ui-button" style="margin-left:5px;" title="Reset to Auto"><i class="fa fa-undo"></i></a>').appendTo($inputGroup);

      // Helper for updating the display text based on Config
      const updateDisplay = () => {
        const configId = $conn.val();
        const configNode = RED.nodes.node(configId);
        const clientName = (configNode && configNode.clientName) ? configNode.clientName : '...';

        $displayText.text(clientName);

        // If config is missing/invalid, fallback to manual?
        if (!configNode) {
          $displayText.text('(No Config Selected)');
          $displayText.css('color', '#999');
        } else {
          $displayText.css('color', '#333');
        }
      };

      // Toggle Logic
      const showDisplay = () => {
        $inputGroup.hide();
        $displayGroup.css('display', 'flex'); // Use flex for alignment
        // Clear input value so it saves as empty (auto)
        // Wait, if we clear it here, on save it will be empty. accessing node.providerId in oneditprepare might be stale.
        // We rely on the input's value. 
        $provIdInput.val('');
        updateDisplay();
        $('#provider-id-helper').text('Using Client ID from selected u-OS Config (default)');
      };

      const showInput = () => {
        $displayGroup.hide();
        $inputGroup.css('display', 'flex');
        $provIdInput.focus();
        $('#provider-id-helper').text('Custom Provider ID (Legacy Mode)');
      };

      // Events
      // $editBtn.on('click', function () {
      //   showInput();
      // }); // Removed as per user request

      $resetBtn.on('click', function () {
        showDisplay();
      });

      $conn.on('change', updateDisplay);

      // Initial State
      // If node.providerId is empty -> Display Mode
      // If node.providerId has value -> Input Mode
      if (!node.providerId) {
        showDisplay();
      } else {
        showInput();
      }
    },
    label: function () {
      return this.name || `DataHub - Provider ${this.providerId || ''}`;
    },
    paletteLabel: "DataHub - Provider",
    labelStyle: function () {
      return this.name ? 'node_label_italic' : '';
    }
  });
</script>

<script type="text/html" data-template-name="datahub-output">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name">
  </div>
  <div class="form-row">
    <label for="node-input-connection"><i class="fa fa-cube"></i> u-OS Config</label>
    <input type="text" id="node-input-connection">
  </div>
  <div class="form-row">
    <label for="node-input-providerId"><i class="fa fa-tag"></i> Provider ID</label>
    <!-- Input is handled dynamically in oneditprepare -->
    <input type="text" id="node-input-providerId" style="display:none;"> 
  </div>
  <div class="form-row">
    <label for="node-input-heartbeatInterval"><i class="fa fa-clock-o"></i> Keep-Alive (s)</label>
    <input type="number" id="node-input-heartbeatInterval" placeholder="300" style="width:100px;">
    <span style="color:#777; font-size:0.9em; margin-left:10px;">(Default: 300s / 5min)</span>
  </div>
</script>

<script type="text/html" data-help-name="datahub-output">
  <p><b>DataHub - Provider</b> creates your own Data Hub provider that other applications can read from in real-time.</p>
  <dl>
    <dt>u-OS Config</dt>
    <dd>Connection node with host/port and OAuth credentials.</dd>
    <dt>Provider ID</dt>
    <dd>The unique ID for this provider.</dd>
    <dd><b>Auto Mode:</b> Shows the <em>Client Name</em> from your Config. Uses this name automatically.</dd>
    <!-- Manual Mode only visible if previously configured -->
  </dl>
  <p>Send a JSON object as <code>msg.payload</code>. Nested objects are flattened using dot-notation to create <strong>subcategories</strong> automatically:</p>
<pre>{
  "machine": {
    "status": "running",
    "details": {
      "temp": 45.2
    }
  }
}</pre>
  <p>becomes variables <code>machine.status</code> and <code>machine.details.temp</code> in the Data Hub.</p>
</script>